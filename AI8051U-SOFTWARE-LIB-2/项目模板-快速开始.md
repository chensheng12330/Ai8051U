# AI8051U é¡¹ç›®æ¨¡æ¿ - å¿«é€Ÿå¼€å§‹

> 5 åˆ†é’Ÿåˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ª AI8051U é¡¹ç›®

---

## ğŸ“‹ æ¨¡æ¿ 1ï¼šæœ€å°ç³»ç»Ÿæ¨¡æ¿

é€‚åˆï¼šå¿«é€ŸéªŒè¯æƒ³æ³•ã€ç®€å•æµ‹è¯•

### æ–‡ä»¶ç»“æ„
```
MyProject/
â”œâ”€â”€ main.c              # ä¸»ç¨‹åº
â”œâ”€â”€ AI8051U_GPIO.c/h    # GPIO é©±åŠ¨
â”œâ”€â”€ AI8051U_Delay.c/h   # å»¶æ—¶å‡½æ•°
â”œâ”€â”€ AI8051U.H           # å¯„å­˜å™¨å®šä¹‰
â”œâ”€â”€ config.h            # é…ç½®æ–‡ä»¶
â””â”€â”€ MyProject.uvproj    # Keil å·¥ç¨‹
```

### main.c æ¨¡æ¿

```c
/*******************************************************************************
 * é¡¹ç›®åç§°: MyProject
 * æ–‡ä»¶åç§°: main.c
 * åˆ›å»ºæ—¥æœŸ: 2025-XX-XX
 * ä½œè€…: Your Name
 * åŠŸèƒ½æè¿°: é¡¹ç›®ä¸»ç¨‹åº
 ******************************************************************************/

#include "config.h"
#include "AI8051U_GPIO.h"
#include "AI8051U_Delay.h"

/*******************************************************************************
 * å‡½æ•°å£°æ˜
 ******************************************************************************/
void System_Init(void);
void GPIO_Init(void);

/*******************************************************************************
 * ä¸»ç¨‹åº
 ******************************************************************************/
void main(void)
{
    // ç³»ç»Ÿåˆå§‹åŒ–
    System_Init();
    
    // å¤–è®¾åˆå§‹åŒ–
    GPIO_Init();
    
    // ä¸»å¾ªç¯
    while(1)
    {
        // ä½ çš„ä»£ç åœ¨è¿™é‡Œ
        P00 = 0;        // LED äº®
        delay_ms(500);
        P00 = 1;        // LED ç­
        delay_ms(500);
    }
}

/*******************************************************************************
 * å‡½æ•°åç§°: System_Init
 * å‡½æ•°åŠŸèƒ½: ç³»ç»Ÿåˆå§‹åŒ–
 * è¾“å…¥å‚æ•°: æ— 
 * è¿”å›å€¼: æ— 
 ******************************************************************************/
void System_Init(void)
{
    WTST = 0;        // CPU æœ€é«˜é€Ÿ
    EAXSFR();        // ä½¿èƒ½æ‰©å±•å¯„å­˜å™¨
    CKCON = 0;       // XRAM é«˜é€Ÿè®¿é—®
    SET_TPS();       // è®¾ç½®æ—¶é—´å•ä½
    
    EA = 1;          // ä½¿èƒ½æ€»ä¸­æ–­
}

/*******************************************************************************
 * å‡½æ•°åç§°: GPIO_Init
 * å‡½æ•°åŠŸèƒ½: GPIO åˆå§‹åŒ–
 * è¾“å…¥å‚æ•°: æ— 
 * è¿”å›å€¼: æ— 
 ******************************************************************************/
void GPIO_Init(void)
{
    P0_MODE_OUT_PP(GPIO_Pin_0);  // P0.0 æ¨æŒ½è¾“å‡º
}
```

---

## ğŸ“‹ æ¨¡æ¿ 2ï¼šä¸²å£è°ƒè¯•æ¨¡æ¿

é€‚åˆï¼šéœ€è¦ä¸²å£è¾“å‡ºè°ƒè¯•ä¿¡æ¯çš„é¡¹ç›®

### æ–‡ä»¶ç»“æ„
```
MyProject/
â”œâ”€â”€ main.c
â”œâ”€â”€ AI8051U_GPIO.c/h
â”œâ”€â”€ AI8051U_UART.c/h
â”œâ”€â”€ AI8051U_UART_Isr.c
â”œâ”€â”€ AI8051U_NVIC.c/h
â”œâ”€â”€ AI8051U.H
â”œâ”€â”€ config.h
â””â”€â”€ MyProject.uvproj
```

### main.c æ¨¡æ¿

```c
#include "config.h"
#include "AI8051U_GPIO.h"
#include "AI8051U_UART.h"

void System_Init(void);
void GPIO_Init(void);
void UART_Init(void);

void main(void)
{
    System_Init();
    GPIO_Init();
    UART_Init();
    
    // å¯åŠ¨ä¿¡æ¯
    printf("\r\n");
    printf("========================================\r\n");
    printf(" Project: MyProject\r\n");
    printf(" Version: V1.0\r\n");
    printf(" Date: 2025-XX-XX\r\n");
    printf("========================================\r\n");
    
    while(1)
    {
        // æ‰“å°è°ƒè¯•ä¿¡æ¯
        printf("System Running...\r\n");
        delay_ms(1000);
    }
}

void System_Init(void)
{
    WTST = 0;
    EAXSFR();
    CKCON = 0;
    SET_TPS();
    EA = 1;
}

void GPIO_Init(void)
{
    P0_MODE_OUT_PP(GPIO_Pin_0);
}

void UART_Init(void)
{
    COMx_InitDefine com;
    
    com.UART_Mode = UART_8bit_BRTx;
    com.UART_BRT_Use = BRT_Timer1;
    com.UART_BaudRate = 115200;
    com.UART_RxEnable = ENABLE;
    com.BaudRateDouble = DISABLE;
    com.ParityMode = PARITY_NONE;
    
    UART_Configuration(UART1, &com);
    NVIC_UART1_Init(ENABLE, Priority_1);
}
```

---

## ğŸ“‹ æ¨¡æ¿ 3ï¼šå¤šä»»åŠ¡è°ƒåº¦æ¨¡æ¿

é€‚åˆï¼šå¤æ‚é¡¹ç›®ï¼Œå¤šä¸ªä»»åŠ¡å¹¶è¡Œ

### æ–‡ä»¶ç»“æ„
```
MyProject/
â”œâ”€â”€ main.c              # ä¸»ç¨‹åº
â”œâ”€â”€ task.c/h            # ä»»åŠ¡è°ƒåº¦
â”œâ”€â”€ system.c/h          # ç³»ç»Ÿåˆå§‹åŒ–
â”œâ”€â”€ hardware/           # ç¡¬ä»¶é©±åŠ¨å±‚
â”‚   â”œâ”€â”€ led.c/h
â”‚   â”œâ”€â”€ key.c/h
â”‚   â””â”€â”€ uart.c/h
â”œâ”€â”€ driver/             # èŠ¯ç‰‡é©±åŠ¨å±‚
â”‚   â”œâ”€â”€ AI8051U_*.c/h
â”‚   â””â”€â”€ ...
â””â”€â”€ MyProject.uvproj
```

### main.c

```c
#include "config.h"
#include "system.h"
#include "task.h"

void main(void)
{
    // ç³»ç»Ÿåˆå§‹åŒ–
    System_Init();
    
    // å¯åŠ¨æ¶ˆæ¯
    printf("System Start!\r\n");
    
    // ä¸»å¾ªç¯ - ä»»åŠ¡è°ƒåº¦
    while(1)
    {
        Task_Handler();  // ä»»åŠ¡å¤„ç†
    }
}
```

### task.h

```c
#ifndef __TASK_H__
#define __TASK_H__

#include "config.h"

// ä»»åŠ¡æ ‡å¿—
extern bit Task_1ms_Flag;
extern bit Task_10ms_Flag;
extern bit Task_100ms_Flag;
extern bit Task_1s_Flag;

// ä»»åŠ¡å‡½æ•°
void Task_Handler(void);
void Task_1ms(void);
void Task_10ms(void);
void Task_100ms(void);
void Task_1s(void);

#endif
```

### task.c

```c
#include "task.h"

// ä»»åŠ¡æ ‡å¿—
bit Task_1ms_Flag = 0;
bit Task_10ms_Flag = 0;
bit Task_100ms_Flag = 0;
bit Task_1s_Flag = 0;

// æ—¶é—´è®¡æ•°
static u16 cnt_10ms = 0;
static u16 cnt_100ms = 0;
static u16 cnt_1s = 0;

/*******************************************************************************
 * å‡½æ•°åç§°: Timer0_ISR
 * å‡½æ•°åŠŸèƒ½: Timer0 ä¸­æ–­ï¼ˆ1ms æ—¶åŸºï¼‰
 ******************************************************************************/
void Timer0_ISR(void) interrupt TMR0_VECTOR
{
    Task_1ms_Flag = 1;  // 1ms ä»»åŠ¡æ ‡å¿—
    
    // ç”Ÿæˆå…¶ä»–æ—¶åŸº
    if(++cnt_10ms >= 10)
    {
        cnt_10ms = 0;
        Task_10ms_Flag = 1;
    }
    
    if(++cnt_100ms >= 100)
    {
        cnt_100ms = 0;
        Task_100ms_Flag = 1;
    }
    
    if(++cnt_1s >= 1000)
    {
        cnt_1s = 0;
        Task_1s_Flag = 1;
    }
}

/*******************************************************************************
 * å‡½æ•°åç§°: Task_Handler
 * å‡½æ•°åŠŸèƒ½: ä»»åŠ¡è°ƒåº¦å™¨
 ******************************************************************************/
void Task_Handler(void)
{
    if(Task_1ms_Flag)
    {
        Task_1ms_Flag = 0;
        Task_1ms();
    }
    
    if(Task_10ms_Flag)
    {
        Task_10ms_Flag = 0;
        Task_10ms();
    }
    
    if(Task_100ms_Flag)
    {
        Task_100ms_Flag = 0;
        Task_100ms();
    }
    
    if(Task_1s_Flag)
    {
        Task_1s_Flag = 0;
        Task_1s();
    }
}

/*******************************************************************************
 * å„ä»»åŠ¡å®ç°
 ******************************************************************************/

// 1ms ä»»åŠ¡ - é«˜ä¼˜å…ˆçº§ï¼Œå¿«é€Ÿå“åº”
void Task_1ms(void)
{
    // æŒ‰é”®æ‰«æ
    Key_Scan();
}

// 10ms ä»»åŠ¡ - å¸¸è§„ä»»åŠ¡
void Task_10ms(void)
{
    // ADC é‡‡æ ·
    ADC_Sample();
}

// 100ms ä»»åŠ¡ - è¾ƒæ…¢ä»»åŠ¡
void Task_100ms(void)
{
    // LED é—ªçƒ
    LED_Toggle();
}

// 1s ä»»åŠ¡ - ä½é¢‘ä»»åŠ¡
void Task_1s(void)
{
    // æ‰“å°çŠ¶æ€
    printf("System OK\r\n");
}
```

---

## ğŸ“‹ æ¨¡æ¿ 4ï¼šçŠ¶æ€æœºæ¨¡æ¿

é€‚åˆï¼šæœ‰å¤šä¸ªå·¥ä½œçŠ¶æ€çš„é¡¹ç›®

### main.c

```c
#include "config.h"
#include "system.h"

// çŠ¶æ€å®šä¹‰
typedef enum
{
    STATE_INIT = 0,     // åˆå§‹åŒ–çŠ¶æ€
    STATE_IDLE,         // ç©ºé—²çŠ¶æ€
    STATE_WORKING,      // å·¥ä½œçŠ¶æ€
    STATE_ERROR,        // é”™è¯¯çŠ¶æ€
    STATE_SLEEP         // ç¡çœ çŠ¶æ€
} SystemState_t;

// å…¨å±€å˜é‡
SystemState_t current_state = STATE_INIT;
SystemState_t next_state = STATE_INIT;

// çŠ¶æ€å¤„ç†å‡½æ•°
void State_Init_Handler(void);
void State_Idle_Handler(void);
void State_Working_Handler(void);
void State_Error_Handler(void);
void State_Sleep_Handler(void);

void main(void)
{
    System_Init();
    
    while(1)
    {
        // çŠ¶æ€æœºè°ƒåº¦
        switch(current_state)
        {
            case STATE_INIT:
                State_Init_Handler();
                break;
                
            case STATE_IDLE:
                State_Idle_Handler();
                break;
                
            case STATE_WORKING:
                State_Working_Handler();
                break;
                
            case STATE_ERROR:
                State_Error_Handler();
                break;
                
            case STATE_SLEEP:
                State_Sleep_Handler();
                break;
                
            default:
                current_state = STATE_INIT;
                break;
        }
        
        // çŠ¶æ€åˆ‡æ¢
        if(next_state != current_state)
        {
            printf("State Change: %d -> %d\r\n", current_state, next_state);
            current_state = next_state;
        }
    }
}

// åˆå§‹åŒ–çŠ¶æ€
void State_Init_Handler(void)
{
    printf("State: INIT\r\n");
    
    // æ‰§è¡Œåˆå§‹åŒ–
    // ...
    
    // åˆ‡æ¢åˆ°ç©ºé—²çŠ¶æ€
    next_state = STATE_IDLE;
}

// ç©ºé—²çŠ¶æ€
void State_Idle_Handler(void)
{
    // ç­‰å¾…äº‹ä»¶
    if(Key_Pressed())
    {
        next_state = STATE_WORKING;
    }
}

// å·¥ä½œçŠ¶æ€
void State_Working_Handler(void)
{
    // æ‰§è¡Œå·¥ä½œ
    printf("Working...\r\n");
    
    // å·¥ä½œå®Œæˆ
    if(Work_Done())
    {
        next_state = STATE_IDLE;
    }
}

// é”™è¯¯çŠ¶æ€
void State_Error_Handler(void)
{
    printf("Error!\r\n");
    LED_Error_Blink();
    
    // æ¢å¤
    if(Error_Recovered())
    {
        next_state = STATE_IDLE;
    }
}

// ç¡çœ çŠ¶æ€
void State_Sleep_Handler(void)
{
    printf("Sleep...\r\n");
    PCON |= 0x01;  // è¿›å…¥ Idle æ¨¡å¼
    
    // å”¤é†’å
    next_state = STATE_IDLE;
}
```

---

## ğŸ“‹ æ¨¡æ¿ 5ï¼šå®Œæ•´é¡¹ç›®æ¡†æ¶

é€‚åˆï¼šå¤§å‹é¡¹ç›®ï¼Œå›¢é˜Ÿå¼€å‘

### ç›®å½•ç»“æ„

```
MyProject/
â”‚
â”œâ”€â”€ Doc/                    # æ–‡æ¡£
â”‚   â”œâ”€â”€ README.md
â”‚   â”œâ”€â”€ è®¾è®¡æ–‡æ¡£.md
â”‚   â””â”€â”€ API æ–‡æ¡£.md
â”‚
â”œâ”€â”€ Hardware/               # ç¡¬ä»¶å±‚
â”‚   â”œâ”€â”€ inc/
â”‚   â”‚   â”œâ”€â”€ led.h
â”‚   â”‚   â”œâ”€â”€ key.h
â”‚   â”‚   â”œâ”€â”€ lcd.h
â”‚   â”‚   â””â”€â”€ sensor.h
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ led.c
â”‚       â”œâ”€â”€ key.c
â”‚       â”œâ”€â”€ lcd.c
â”‚       â””â”€â”€ sensor.c
â”‚
â”œâ”€â”€ Driver/                 # é©±åŠ¨å±‚ï¼ˆAI8051U åº“æ–‡ä»¶ï¼‰
â”‚   â”œâ”€â”€ AI8051U_*.c/h
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ App/                    # åº”ç”¨å±‚
â”‚   â”œâ”€â”€ inc/
â”‚   â”‚   â”œâ”€â”€ app.h
â”‚   â”‚   â”œâ”€â”€ protocol.h
â”‚   â”‚   â””â”€â”€ algorithm.h
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ app.c
â”‚       â”œâ”€â”€ protocol.c
â”‚       â””â”€â”€ algorithm.c
â”‚
â”œâ”€â”€ User/                   # ç”¨æˆ·å±‚
â”‚   â”œâ”€â”€ main.c
â”‚   â”œâ”€â”€ config.h
â”‚   â”œâ”€â”€ system.c/h
â”‚   â””â”€â”€ task.c/h
â”‚
â”œâ”€â”€ Project/                # å·¥ç¨‹æ–‡ä»¶
â”‚   â””â”€â”€ MyProject.uvproj
â”‚
â””â”€â”€ Output/                 # è¾“å‡ºæ–‡ä»¶
    â”œâ”€â”€ *.hex
    â””â”€â”€ *.map
```

---

## ğŸ”§ Keil å·¥ç¨‹é…ç½®

### 1. Target è®¾ç½®

```
Target â†’ Target Options
â”œâ”€â”€ Device: AI8051Uï¼ˆé€‰æ‹©å¯¹åº”å‹å·ï¼‰
â”œâ”€â”€ Xtal (MHz): 40.0ï¼ˆæ ¹æ®å®é™…ä¸»é¢‘ï¼‰
â””â”€â”€ Memory Model: Large
```

### 2. Output è®¾ç½®

```
Output â†’ Output Options
â”œâ”€â”€ âœ“ Create HEX File
â”œâ”€â”€ Name of Executable: MyProject
â””â”€â”€ Select Folder for Objects: ./Objects/
```

### 3. C51 ç¼–è¯‘é€‰é¡¹

```
C51 â†’ C51 Options
â”œâ”€â”€ Optimization Level: 9ï¼ˆæœ€é«˜ä¼˜åŒ–ï¼‰
â”œâ”€â”€ âœ“ Browse Information
â””â”€â”€ Define: æ ¹æ®éœ€è¦å®šä¹‰å®
```

### 4. BL51 é“¾æ¥é€‰é¡¹

```
BL51 â†’ BL51 Options
â”œâ”€â”€ XDATA: 0x0000-0x3FFFï¼ˆæ ¹æ®å®é™…ï¼‰
â”œâ”€â”€ CODE: 0x0000-0x7FFFï¼ˆæ ¹æ®å®é™…ï¼‰
â””â”€â”€ âœ“ Use Memory Layout from Target Dialog
```

---

## ğŸ“ ä»£ç è§„èŒƒå»ºè®®

### æ–‡ä»¶å¤´æ³¨é‡Š

```c
/*******************************************************************************
 * æ–‡ä»¶åç§°: filename.c
 * é¡¹ç›®åç§°: ProjectName
 * åˆ›å»ºæ—¥æœŸ: 2025-XX-XX
 * ä½œ    è€…: Your Name
 * ç‰ˆ    æœ¬: V1.0
 * åŠŸèƒ½æè¿°: ç®€è¦æè¿°æ–‡ä»¶åŠŸèƒ½
 * ä¿®æ”¹è®°å½•:
 *   2025-XX-XX V1.0 åˆå§‹ç‰ˆæœ¬
 ******************************************************************************/
```

### å‡½æ•°æ³¨é‡Š

```c
/*******************************************************************************
 * å‡½æ•°åç§°: Function_Name
 * å‡½æ•°åŠŸèƒ½: ç®€è¦æè¿°å‡½æ•°åŠŸèƒ½
 * è¾“å…¥å‚æ•°: param1 - å‚æ•° 1 è¯´æ˜
 *          param2 - å‚æ•° 2 è¯´æ˜
 * è¿” å› å€¼: è¿”å›å€¼è¯´æ˜
 * è¯´    æ˜: å…¶ä»–è¯´æ˜ï¼ˆå¯é€‰ï¼‰
 ******************************************************************************/
```

### å‘½åè§„èŒƒ

```c
// å®å®šä¹‰ - å…¨å¤§å†™ï¼Œä¸‹åˆ’çº¿åˆ†éš”
#define MAX_BUFFER_SIZE  128
#define LED_PIN          P00

// å˜é‡ - å°å†™ï¼Œä¸‹åˆ’çº¿åˆ†éš”
u8 buffer_count;
u16 adc_value;

// å‡½æ•° - é¦–å­—æ¯å¤§å†™ï¼Œä¸‹åˆ’çº¿åˆ†éš”
void System_Init(void);
u8 Get_ADC_Value(u8 channel);

// ç±»å‹å®šä¹‰ - é¦–å­—æ¯å¤§å†™ï¼Œ_t ç»“å°¾
typedef struct
{
    u8 data;
    u8 length;
} Buffer_t;
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹æ­¥éª¤

### æ­¥éª¤ 1ï¼šå¤åˆ¶æ¨¡æ¿

ä» `åº“æ–‡ä»¶/` ç›®å½•å¤åˆ¶éœ€è¦çš„æ–‡ä»¶åˆ°ä½ çš„é¡¹ç›®ç›®å½•ã€‚

### æ­¥éª¤ 2ï¼šåˆ›å»º Keil å·¥ç¨‹

1. æ‰“å¼€ Keilï¼Œæ–°å»ºå·¥ç¨‹
2. é€‰æ‹© AI8051U èŠ¯ç‰‡
3. æ·»åŠ æºæ–‡ä»¶åˆ°å·¥ç¨‹
4. é…ç½®å·¥ç¨‹é€‰é¡¹

### æ­¥éª¤ 3ï¼šä¿®æ”¹é…ç½®

åœ¨ `config.h` ä¸­é…ç½®ä¸»é¢‘ã€å¤–è®¾ç­‰ï¼š

```c
#define MAIN_Fosc  40000000L  // ä¸»é¢‘
```

### æ­¥éª¤ 4ï¼šç¼–å†™ä»£ç 

åœ¨ `main.c` ä¸­ç¼–å†™ä½ çš„åº”ç”¨ä»£ç ã€‚

### æ­¥éª¤ 5ï¼šç¼–è¯‘ä¸‹è½½

1. æŒ‰ `F7` ç¼–è¯‘
2. ä½¿ç”¨ STC-ISP ä¸‹è½½
3. æµ‹è¯•è¿è¡Œ

---

## ğŸ’¡ æç¤º

1. **ä»ç®€å•å¼€å§‹** - å…ˆç”¨æœ€å°ç³»ç»Ÿæ¨¡æ¿éªŒè¯åŸºæœ¬åŠŸèƒ½
2. **é€æ­¥æ·»åŠ ** - éœ€è¦ä»€ä¹ˆåŠŸèƒ½å°±æ·»åŠ å¯¹åº”çš„é©±åŠ¨æ–‡ä»¶
3. **å‚è€ƒç¤ºä¾‹** - å‚è€ƒ `ç‹¬ç«‹ç¨‹åº/` ä¸­çš„ä¾‹å­
4. **ä¿æŒæ•´æ´** - åŠæ—¶åˆ é™¤ä¸éœ€è¦çš„ä»£ç å’Œæ–‡ä»¶
5. **ç‰ˆæœ¬æ§åˆ¶** - ä½¿ç”¨ Git ç®¡ç†ä½ çš„é¡¹ç›®

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [AI8051U-ä½¿ç”¨æ–‡æ¡£.md](./AI8051U-ä½¿ç”¨æ–‡æ¡£.md) - è¯¦ç»†æ•™ç¨‹
- [AI8051U-å¿«é€Ÿå‚è€ƒ.md](./AI8051U-å¿«é€Ÿå‚è€ƒ.md) - å¿«é€ŸæŸ¥è¯¢
- [README.md](./README.md) - é¡¹ç›®æ€»è§ˆ

---

## ğŸ¯ ä¸‹ä¸€æ­¥

é€‰æ‹©åˆé€‚çš„æ¨¡æ¿ï¼Œå¼€å§‹ä½ çš„ AI8051U é¡¹ç›®å§ï¼

**ç¥å¼€å‘é¡ºåˆ©ï¼** ğŸš€

