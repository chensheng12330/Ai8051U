# 摩托车智能联动灯组系统 - 技术方案文档

> **版本：** v1.0.0  
> **日期：** 2025-11-17  
> **平台：** AI8051U (48MHz)  
> **作者：** Sherwin.Chen

---

## 📋 目录

1. [项目概述](#项目概述)
2. [系统架构](#系统架构)
3. [执行流程](#执行流程)
4. [时序设计](#时序设计)
5. [功能模块](#功能模块)
6. [数据流](#数据流)
7. [性能指标](#性能指标)

---

## 项目概述

### 系统简介

摩托车智能联动灯组系统是一款基于AI8051U单片机的智能灯光控制系统，能够根据原车信号（刹车、转向、远近光等）自动控制多种灯光效果，提升摩托车的安全性和美观性。

### 核心特性

- ✅ **优先级调度机制**：刹车 > 转向 > 位置灯 > 远近光 > 音乐频谱
- ✅ **90颗WS2812B氛围灯**：支持多种炫彩效果（流水、呼吸、彩虹、频谱等）
- ✅ **RGB灯组控制**：前轮+车底共用RGB灯，256级PWM调光
- ✅ **环境光自适应**：自动切换白天/夜晚模式
- ✅ **多种输入方式**：原车信号检测、按键交互、传感器采集
- ✅ **完善的监控系统**：CPU占用率监控、任务性能分析
- ✅ **USB HID调试**：实时输出系统状态

### 技术指标

| 指标项 | 数值 | 说明 |
|--------|------|------|
| CPU主频 | 48MHz | 可配置24/48/72MHz |
| CPU占用率 | < 30% | 正常运行时平均占用 |
| 任务响应时间 | < 50ms | 从信号检测到灯光响应 |
| WS2812B刷新率 | 50Hz | 20ms更新一次 |
| PWM频率 | 100Hz | 10ms更新一次 |
| 按键响应时间 | < 30ms | 包含消抖时间 |
| 系统启动时间 | < 500ms | 从上电到正常运行 |

---

## 系统架构

### 整体架构图

```mermaid
graph TB
    subgraph "硬件层"
        HW[AI8051U MCU<br/>48MHz]
        LED[WS2812B<br/>90颗LED]
        RGB[RGB灯组<br/>3路PWM]
        BRAKE[刹车灯<br/>PWM]
        BUZZER[蜂鸣器<br/>PWM]
        KEY[按键<br/>3个中断]
        SENSOR[传感器<br/>ADC]
    end
    
    subgraph "硬件抽象层 HAL"
        GPIO[GPIO驱动]
        TIMER[Timer0<br/>1ms时基]
        ADC[ADC驱动<br/>12位]
        PWM[软件PWM<br/>8位]
        UART[UART4<br/>115200]
    end
    
    subgraph "任务调度层"
        TASK[任务调度器<br/>协作式多任务]
        WDT[看门狗<br/>1秒超时]
        MONITOR[监控插件<br/>CPU/任务]
    end
    
    subgraph "应用层"
        APP[主应用层<br/>app_moto_lights]
        VS[原车信号检测<br/>app_vehicle_signal]
        LS[灯光调度器<br/>app_light_scheduler]
        WS[WS2812B控制<br/>app_ws2812b]
        PWMO[PWM输出<br/>app_pwm_output]
        SEN[传感器管理<br/>app_sensors]
        KEYH[按键处理<br/>app_intKey]
    end
    
    HW --> GPIO
    HW --> TIMER
    HW --> ADC
    HW --> PWM
    HW --> UART
    
    GPIO --> LED
    GPIO --> RGB
    GPIO --> BRAKE
    GPIO --> BUZZER
    GPIO --> KEY
    ADC --> SENSOR
    
    TIMER --> TASK
    TASK --> APP
    TASK --> VS
    TASK --> LS
    TASK --> WS
    TASK --> PWMO
    TASK --> SEN
    TASK --> KEYH
    
    APP --> VS
    APP --> LS
    APP --> SEN
    APP --> KEYH
    
    LS --> WS
    LS --> PWMO
    
    WDT --> TASK
    MONITOR --> TASK
```

### 模块层次结构

```mermaid
graph TD
    MAIN[main.c<br/>主程序入口]
    INIT[System_init.c<br/>系统初始化]
    TASK[Task.c<br/>任务调度]
    APP[app.c<br/>应用配置]
    
    MAIN --> INIT
    MAIN --> TASK
    MAIN --> APP
    
    APP --> MOTO[app_moto_lights.c<br/>主应用层协调器]
    
    MOTO --> VS[app_vehicle_signal.c<br/>原车信号检测]
    MOTO --> SEN[app_sensors.c<br/>传感器管理]
    MOTO --> KEY[app_intKey.c<br/>按键输入]
    MOTO --> LS[app_light_scheduler.c<br/>灯光调度器]
    
    LS --> WS[app_ws2812b.c<br/>WS2812B控制]
    LS --> PWM[app_pwm_output.c<br/>PWM输出控制]
    
    CONFIG[moto_lights_config.h<br/>系统配置]
    PINMAP[moto_lights_pinmap.h<br/>引脚映射]
    
    MOTO -.-> CONFIG
    MOTO -.-> PINMAP
    VS -.-> CONFIG
    VS -.-> PINMAP
    WS -.-> CONFIG
    WS -.-> PINMAP
```

### 数据流向图

```mermaid
flowchart LR
    subgraph "输入层"
        SIGNAL[原车信号<br/>P0.0-P0.5]
        KEY_IN[按键输入<br/>P3.2/P3.6/P3.7]
        ADC_IN[传感器<br/>P0.6/P0.7]
    end
    
    subgraph "处理层"
        VS_PROC[信号检测<br/>消抖/边沿检测]
        KEY_PROC[按键处理<br/>短按/长按识别]
        SEN_PROC[传感器处理<br/>滤波/转换]
        SCHED[优先级调度器<br/>场景选择]
        RENDER[场景渲染<br/>效果生成]
    end
    
    subgraph "输出层"
        WS_OUT[WS2812B<br/>90颗LED]
        RGB_OUT[RGB灯组<br/>3路PWM]
        BRAKE_OUT[刹车灯<br/>PWM]
        BUZZER_OUT[蜂鸣器<br/>PWM]
        LED_OUT[状态LED<br/>GPIO]
    end
    
    SIGNAL --> VS_PROC
    KEY_IN --> KEY_PROC
    ADC_IN --> SEN_PROC
    
    VS_PROC --> SCHED
    KEY_PROC --> SCHED
    SEN_PROC --> SCHED
    
    SCHED --> RENDER
    RENDER --> WS_OUT
    RENDER --> RGB_OUT
    RENDER --> BRAKE_OUT
    RENDER --> BUZZER_OUT
    RENDER --> LED_OUT
```

---

## 执行流程

### 系统启动流程

```mermaid
flowchart TD
    START([系统上电])
    INIT_HW[硬件初始化<br/>WTST/EAXFR/CKCON]
    SYS_INIT[SYS_Init<br/>系统初始化]
    USB_INIT[USB初始化<br/>usb_init]
    MONITOR_INIT[监控插件初始化<br/>TaskMonitor/CPUMonitor]
    WDT_INIT[看门狗初始化<br/>1秒超时]
    APP_INIT[应用初始化<br/>MotoLights_Init]
    
    START --> INIT_HW
    INIT_HW --> SYS_INIT
    SYS_INIT --> USB_INIT
    USB_INIT --> MONITOR_INIT
    MONITOR_INIT --> WDT_INIT
    WDT_INIT --> APP_INIT
    
    APP_INIT --> MODULE_INIT[模块初始化]
    
    MODULE_INIT --> SEN_INIT[传感器模块<br/>Sensors_Init]
    SEN_INIT --> VS_INIT[信号检测模块<br/>VehicleSignal_Init]
    VS_INIT --> WS_INIT[WS2812B模块<br/>WS2812B_Init]
    WS_INIT --> PWM_INIT[PWM输出模块<br/>PWM_Output_Init]
    PWM_INIT --> LS_INIT[灯光调度器<br/>LightScheduler_Init]
    LS_INIT --> KEY_INIT[按键模块<br/>intKey_init]
    KEY_INIT --> REG_CB[注册回调函数]
    
    REG_CB --> MAIN_LOOP[主循环]
    
    MAIN_LOOP --> WDT_FEED[喂狗操作]
    WDT_FEED --> USB_PROC[USB数据处理]
    USB_PROC --> TASK_RUN[任务调度执行]
    TASK_RUN --> CPU_IDLE[CPU空闲计数]
    CPU_IDLE --> MAIN_LOOP
    
    style START fill:#90EE90
    style MAIN_LOOP fill:#FFB6C1
    style APP_INIT fill:#87CEEB
```

### 主循环执行流程

```mermaid
flowchart TD
    LOOP_START([主循环开始])
    WDT["喂狗操作<br/>WDT_CONTR 置位"]
    USB_CHECK{USB数据<br/>就绪?}
    USB_PROC["USB数据处理<br/>usb_OUT_done"]
    TASK_RUN["任务调度执行<br/>Task_Pro_Handler"]
    CPU_TICK["CPU空闲计数<br/>CPU_MONITOR_IDLE_TICK"]
    
    LOOP_START --> WDT
    WDT --> USB_CHECK
    USB_CHECK -->|是| USB_PROC
    USB_CHECK -->|否| TASK_RUN
    USB_PROC --> TASK_RUN
    TASK_RUN --> CPU_TICK
    CPU_TICK --> LOOP_START
    
    style LOOP_START fill:#90EE90
    style WDT fill:#FFD700
    style TASK_RUN fill:#87CEEB
```

### 任务调度流程

```mermaid
flowchart TD
    TIMER_INT[Timer0中断<br/>1ms触发]
    TASK_MARK[任务标记处理<br/>Task_Marks_Handler]
    DEC_COUNT[计数器递减]
    CHECK{计数器<br/>为0?}
    SET_FLAG[设置运行标志<br/>Run = 1]
    
    MAIN_LOOP[主循环]
    TASK_EXEC[任务执行处理<br/>Task_Pro_Handler]
    CHECK_TASK{任务标志<br/>Run = 1?}
    EXEC_TASK[执行任务函数<br/>TaskHook]
    CLEAR_FLAG[清除标志<br/>Run = 0]
    
    TIMER_INT --> TASK_MARK
    TASK_MARK --> DEC_COUNT
    DEC_COUNT --> CHECK
    CHECK -->|是| SET_FLAG
    CHECK -->|否| END_MARK[结束标记处理]
    SET_FLAG --> END_MARK
    
    MAIN_LOOP --> TASK_EXEC
    TASK_EXEC --> CHECK_TASK
    CHECK_TASK -->|是| EXEC_TASK
    CHECK_TASK -->|否| NEXT_TASK[下一个任务]
    EXEC_TASK --> CLEAR_FLAG
    CLEAR_FLAG --> NEXT_TASK
    NEXT_TASK --> CHECK_TASK
    
    style TIMER_INT fill:#FF6B6B
    style MAIN_LOOP fill:#4ECDC4
    style EXEC_TASK fill:#95E1D3
```

### 信号处理流程

```mermaid
flowchart TD
    SIGNAL_IN[原车信号输入<br/>P0.0-P0.5]
    SAMPLE[信号采样<br/>每10ms]
    READ_GPIO[读取GPIO状态]
    DEBOUNCE[消抖处理<br/>20ms确认]
    EDGE_DETECT[边沿检测<br/>上升沿/下降沿]
    CALLBACK[触发回调函数<br/>MotoLights_SignalEventHandler]
    SCENE_ACT[激活/失效场景<br/>LightScheduler]
    RENDER[场景渲染<br/>灯光效果]
    
    SIGNAL_IN --> SAMPLE
    SAMPLE --> READ_GPIO
    READ_GPIO --> DEBOUNCE
    DEBOUNCE --> EDGE_DETECT
    EDGE_DETECT -->|状态变化| CALLBACK
    CALLBACK --> SCENE_ACT
    SCENE_ACT --> RENDER
    
    style SIGNAL_IN fill:#FFD93D
    style CALLBACK fill:#6BCB77
    style RENDER fill:#4D96FF
```

### 场景调度流程

```mermaid
flowchart TD
    SCENE_IN[场景激活请求]
    CHECK_PRIORITY[检查优先级]
    FIND_MAX[查找最高优先级场景]
    CHECK_ACTIVE{场景已激活?}
    UPDATE_TIME[更新激活时间]
    CHECK_DURATION{持续时间<br/>已到?}
    DEACTIVATE[失效场景]
    ACTIVATE[激活场景]
    RENDER_SCENE[渲染场景效果]
    
    SCENE_IN --> CHECK_PRIORITY
    CHECK_PRIORITY --> FIND_MAX
    FIND_MAX --> CHECK_ACTIVE
    CHECK_ACTIVE -->|是| UPDATE_TIME
    CHECK_ACTIVE -->|否| ACTIVATE
    UPDATE_TIME --> CHECK_DURATION
    CHECK_DURATION -->|是| DEACTIVATE
    CHECK_DURATION -->|否| RENDER_SCENE
    ACTIVATE --> RENDER_SCENE
    
    style SCENE_IN fill:#FF6B6B
    style FIND_MAX fill:#4ECDC4
    style RENDER_SCENE fill:#95E1D3
```

---

## 时序设计

### 任务调度时序图

```mermaid
gantt
    title 任务调度时序图（0-100ms）
    dateFormat X
    axisFormat %L ms
    
    section Timer0中断
    1ms中断触发 :0, 1
    1ms中断触发 :10, 1
    1ms中断触发 :20, 1
    1ms中断触发 :30, 1
    1ms中断触发 :40, 1
    1ms中断触发 :50, 1
    1ms中断触发 :60, 1
    1ms中断触发 :70, 1
    1ms中断触发 :80, 1
    1ms中断触发 :90, 1
    1ms中断触发 :100, 1
    
    section 10ms任务
    原车信号检测 :0, 10
    原车信号检测 :10, 10
    原车信号检测 :20, 10
    PWM输出更新 :0, 10
    PWM输出更新 :10, 10
    PWM输出更新 :20, 10
    按键扫描 :0, 10
    按键扫描 :10, 10
    按键扫描 :20, 10
    
    section 20ms任务
    灯光调度器 :0, 20
    灯光调度器 :20, 20
    灯光调度器 :40, 20
    
    section 50ms任务
    主应用层 :0, 50
    主应用层 :50, 50
    
    section 100ms任务
    传感器采样 :0, 100
    状态指示 :0, 100
```

### 中断与主循环交互时序

```mermaid
sequenceDiagram
    participant Timer0 as Timer0中断
    participant Mark as 任务标记处理
    participant Main as 主循环
    participant Task as 任务执行处理
    participant App as 应用任务
    
    Note over Timer0,App: 系统运行周期（1ms）
    
    Timer0->>Mark: 1ms中断触发
    activate Mark
    Mark->>Mark: 所有任务计数器-1
    Mark->>Mark: 计数器为0时设置Run标志
    deactivate Mark
    
    Main->>Task: 检查任务标志
    activate Task
    Task->>Task: 遍历所有任务
    Task->>Task: 检查Run标志
    
    alt Run = 1
        Task->>App: 调用任务函数
        activate App
        App->>App: 执行任务逻辑
        deactivate App
        Task->>Task: 清除Run标志
    end
    
    deactivate Task
    Main->>Main: CPU空闲计数
    Main->>Main: 喂狗操作
```

### 信号检测时序

```mermaid
sequenceDiagram
    participant Signal as 原车信号
    participant GPIO as GPIO输入
    participant Sample as 信号采样任务
    participant Debounce as 消抖处理
    participant Edge as 边沿检测
    participant Callback as 回调函数
    participant Scene as 场景调度器
    
    Note over Signal,Scene: 信号检测周期（10ms）
    
    Signal->>GPIO: 信号电平变化
    Sample->>GPIO: 读取GPIO状态
    GPIO-->>Sample: 当前电平值
    
    Sample->>Debounce: 消抖处理（20ms）
    activate Debounce
    Debounce->>Debounce: 连续20ms确认
    deactivate Debounce
    
    Debounce->>Edge: 边沿检测
    activate Edge
    Edge->>Edge: 比较当前/上次状态
    Edge-->>Edge: 检测到上升沿/下降沿
    deactivate Edge
    
    Edge->>Callback: 触发回调函数
    activate Callback
    Callback->>Scene: 激活/失效场景
    activate Scene
    Scene->>Scene: 更新场景状态
    Scene->>Scene: 渲染灯光效果
    deactivate Scene
    deactivate Callback
```

### 场景切换时序

```mermaid
sequenceDiagram
    participant Signal as 原车信号
    participant Scheduler as 调度器
    participant Priority as 优先级判断
    participant Render as 场景渲染
    participant WS2812B as WS2812B驱动
    participant PWM as PWM驱动
    
    Signal->>Scheduler: 刹车信号激活
    activate Scheduler
    Scheduler->>Scheduler: 激活SCENE_BRAKE
    
    Scheduler->>Priority: 检查所有场景优先级
    activate Priority
    Priority->>Priority: 查找最高优先级场景
    Priority-->>Scheduler: SCENE_BRAKE (优先级100)
    deactivate Priority
    
    Scheduler->>Render: 渲染刹车场景
    activate Render
    Render->>WS2812B: 设置尾部区域红色高亮
    Render->>PWM: 设置刹车灯全亮
    Render->>PWM: 设置RGB红色
    deactivate Render
    
    Signal->>Scheduler: 左转信号激活
    Scheduler->>Scheduler: 激活SCENE_TURN_LEFT
    
    Scheduler->>Priority: 检查优先级
    activate Priority
    Priority-->>Scheduler: SCENE_BRAKE仍为最高
    deactivate Priority
    
    Note over Scheduler,Render: 刹车场景继续，左转被抑制
    
    Signal->>Scheduler: 刹车信号释放
    Scheduler->>Scheduler: 失效SCENE_BRAKE
    
    Scheduler->>Priority: 重新检查优先级
    activate Priority
    Priority-->>Scheduler: SCENE_TURN_LEFT (优先级90)
    deactivate Priority
    
    Scheduler->>Render: 渲染左转场景
    activate Render
    Render->>WS2812B: 左侧区域橙色流水效果
    deactivate Render
```

---

## 功能模块

### 1. 原车信号检测模块 (app_vehicle_signal)

#### 功能描述

检测原车信号（刹车、转向、远近光等），进行消抖处理和边沿检测，触发场景切换。

#### 核心功能

- **信号采样**：每10ms采样一次GPIO状态
- **消抖处理**：20ms连续确认，避免误触发
- **边沿检测**：检测上升沿和下降沿
- **回调机制**：信号变化时触发回调函数

#### 信号类型

| 信号类型 | 引脚 | 优先级 | 对应场景 |
|---------|------|--------|---------|
| 刹车信号 | P0.0 | 100 | SCENE_BRAKE |
| 雾灯信号 | P0.1 | 80 | SCENE_POSITION_LIGHT |
| 近光灯信号 | P0.2 | 70 | SCENE_NEAR_LIGHT |
| 远光灯信号 | P0.3 | 70 | SCENE_FAR_LIGHT |
| 左转向信号 | P0.4 | 90 | SCENE_TURN_LEFT |
| 右转向信号 | P0.5 | 90 | SCENE_TURN_RIGHT |

#### 状态机

```mermaid
stateDiagram-v2
    [*] --> 采样
    采样 --> 消抖中: 状态变化
    消抖中 --> 采样: 状态恢复
    消抖中 --> 边沿检测: 20ms确认
    边沿检测 --> 触发回调: 检测到边沿
    触发回调 --> 采样: 回调完成
    边沿检测 --> 采样: 无边沿
```

### 2. 灯光调度器模块 (app_light_scheduler)

#### 功能描述

基于优先级的场景调度系统，管理多个灯光场景的激活和渲染。

#### 优先级定义

```mermaid
graph TD
    P100[优先级100<br/>刹车场景<br/>最高优先级]
    P90[优先级90<br/>转向场景<br/>左转/右转]
    P80[优先级80<br/>位置灯场景]
    P70[优先级70<br/>远近光场景]
    P65[优先级65<br/>喇叭效果场景]
    P60[优先级60<br/>音频频谱场景]
    P50[优先级50<br/>环境光效场景]
    P0[优先级0<br/>空闲场景<br/>默认场景]
    
    P100 --> P90
    P90 --> P80
    P80 --> P70
    P70 --> P65
    P65 --> P60
    P60 --> P50
    P50 --> P0
```

#### 场景定义

| 场景 | 优先级 | 触发条件 | 持续时间 | 灯光效果 |
|------|--------|---------|---------|---------|
| SCENE_BRAKE | 100 | 刹车信号激活 | 持续 | 尾灯+尾部区域红色高亮 |
| SCENE_TURN_LEFT | 90 | 左转信号激活 | 持续 | 左侧橙色流水效果 |
| SCENE_TURN_RIGHT | 90 | 右转信号激活 | 持续 | 右侧橙色流水效果 |
| SCENE_POSITION_LIGHT | 80 | 雾灯信号激活 | 持续 | 全部低亮度+刹车灯闪烁 |
| SCENE_NEAR_LIGHT | 70 | 近光信号激活 | 持续 | 全部中等亮度白色 |
| SCENE_FAR_LIGHT | 70 | 远光信号激活 | 持续 | 全部快闪白色 |
| SCENE_HORN_EFFECT | 65 | 音频检测到喇叭 | 3秒 | 前部红色快闪 |
| SCENE_AUDIO_SPECTRUM | 60 | 检测到音频 | 持续 | 显示8频段频谱 |
| SCENE_IDLE | 0 | 默认 | 持续 | 所有灯光关闭 |

#### 调度算法

```mermaid
flowchart TD
    START[场景激活请求]
    CHECK_ALL[遍历所有场景]
    FIND_ACTIVE[查找激活的场景]
    CHECK_PRIORITY{有激活场景?}
    FIND_MAX[查找最高优先级]
    CHECK_CURRENT{当前场景<br/>是否最高?}
    SWITCH[切换场景]
    KEEP[保持当前场景]
    RENDER[渲染场景效果]
    
    START --> CHECK_ALL
    CHECK_ALL --> FIND_ACTIVE
    FIND_ACTIVE --> CHECK_PRIORITY
    CHECK_PRIORITY -->|是| FIND_MAX
    CHECK_PRIORITY -->|否| RENDER
    FIND_MAX --> CHECK_CURRENT
    CHECK_CURRENT -->|否| SWITCH
    CHECK_CURRENT -->|是| KEEP
    SWITCH --> RENDER
    KEEP --> RENDER
```

### 3. WS2812B控制模块 (app_ws2812b)

#### 功能描述

控制90颗WS2812B LED灯珠，支持多种灯光效果和区域控制。

#### 灯珠分区

```mermaid
graph LR
    subgraph "WS2812B灯珠分区（90颗）"
        FL[前左区域<br/>0-14<br/>15颗]
        FR[前右区域<br/>15-29<br/>15颗]
        BL[车身左侧<br/>30-49<br/>20颗]
        BR[车身右侧<br/>50-69<br/>20颗]
        REAR[尾部区域<br/>70-89<br/>20颗]
    end
    
    FL --> FR
    FR --> BL
    BL --> BR
    BR --> REAR
```

#### 灯光效果类型

```mermaid
graph TD
    EFFECT[灯光效果]
    
    EFFECT --> STATIC[静态效果<br/>固定颜色和亮度]
    EFFECT --> BREATHING[呼吸效果<br/>亮度周期性变化<br/>2秒周期]
    EFFECT --> FLOWING[流水效果<br/>带拖尾的流动<br/>用于转向灯]
    EFFECT --> FLASHING[闪烁效果<br/>50%占空比闪烁]
    EFFECT --> RAINBOW[彩虹效果<br/>全LED渐变彩虹色]
    EFFECT --> SPECTRUM[频谱效果<br/>实时音频频谱显示<br/>8频段]
```

#### 效果实现原理

**流水效果（转向灯）：**
```
时间轴: 0ms    100ms   200ms   300ms   400ms   500ms
LED0:   ●      ◐      ○      ○      ○      ●
LED1:   ○      ●      ◐      ○      ○      ○
LED2:   ○      ○      ●      ◐      ○      ○
LED3:   ○      ○      ○      ●      ◐      ○
LED4:   ○      ○      ○      ○      ●      ◐
```

**呼吸效果：**
```
亮度 = 128 + 127 * sin(2π * t / 2000)
周期: 2000ms
范围: 0-255
```

### 4. PWM输出模块 (app_pwm_output)

#### 功能描述

软件PWM输出控制，支持RGB灯组、刹车灯、蜂鸣器等设备。

#### PWM通道

| 通道 | 引脚 | 功能 | 频率 | 分辨率 |
|------|------|------|------|--------|
| RGB红色 | P1.1 | RGB灯组红色 | 1000Hz | 8位(0-255) |
| RGB绿色 | P1.2 | RGB灯组绿色 | 1000Hz | 8位(0-255) |
| RGB蓝色 | P1.3 | RGB灯组蓝色 | 1000Hz | 8位(0-255) |
| 刹车灯 | P1.0 | 尾箱刹车灯 | 1000Hz | 8位(0-255) |
| 蜂鸣器 | P1.5 | 声音提示 | 可变 | 8位(0-255) |

#### PWM更新流程

```mermaid
flowchart TD
    TASK[PWM更新任务<br/>每10ms]
    UPDATE_RGB[更新RGB通道]
    UPDATE_BRAKE[更新刹车灯]
    UPDATE_BUZZER[更新蜂鸣器]
    CALC_DUTY[计算占空比]
    SET_GPIO[设置GPIO状态]
    
    TASK --> UPDATE_RGB
    TASK --> UPDATE_BRAKE
    TASK --> UPDATE_BUZZER
    
    UPDATE_RGB --> CALC_DUTY
    UPDATE_BRAKE --> CALC_DUTY
    UPDATE_BUZZER --> CALC_DUTY
    
    CALC_DUTY --> SET_GPIO
```

### 5. 传感器管理模块 (app_sensors)

#### 功能描述

管理光强传感器、电池电压传感器、音频传感器，进行采样、滤波和物理值转换。

#### 传感器类型

| 传感器 | 引脚 | ADC通道 | 采样周期 | 功能 |
|--------|------|---------|---------|------|
| 光强传感器 | P0.6 | ADC6 | 100ms | 环境光检测，切换白天/夜晚模式 |
| 电池电压 | P0.7 | ADC7 | 100ms | 电压监控，低电压报警 |
| 音频信号 | P0.6 | ADC6 | 100ms | 音频频谱分析 |

#### 工作模式切换

```mermaid
stateDiagram-v2
    [*] --> 白天模式: 光强 > 800
    白天模式 --> 夜晚模式: 光强 < 300
    夜晚模式 --> 白天模式: 光强 > 800
```

**模式参数说明：**

- **白天模式**：
  - WS2812B亮度: 180
  - RGB亮度: 高
  - 效果: 简洁明快

- **夜晚模式**：
  - WS2812B亮度: 255
  - RGB亮度: 中
  - 效果: 绚丽醒目

#### 滤波算法

```mermaid
flowchart TD
    ADC_READ[ADC采样<br/>12位 0-4095]
    FILTER_BUF[移动平均滤波<br/>8点滑动窗口]
    CALC_AVG[计算平均值]
    CONVERT[物理值转换]
    UPDATE[更新传感器数据]
    
    ADC_READ --> FILTER_BUF
    FILTER_BUF --> CALC_AVG
    CALC_AVG --> CONVERT
    CONVERT --> UPDATE
```

### 6. 按键处理模块 (app_intKey)

#### 功能描述

外部中断按键处理，支持短按、长按识别，消抖处理。

#### 按键定义

| 按键 | 引脚 | 中断 | 功能 |
|------|------|------|------|
| 菜单按键 | P3.7 | INT0 | 短按：进入/退出测试模式 |
| 测试按键 | P3.6 | INT2 | 短按：测试所有灯光<br/>长按：顺序测试各区域 |
| 亮度按键 | P3.2 | INT3 | 短按：循环调节亮度（33%→66%→100%） |

#### 按键状态机

```mermaid
stateDiagram-v2
    [*] --> 空闲
    空闲 --> 按下检测: 下降沿中断
    按下检测 --> 消抖中: 20ms确认
    消抖中 --> 按下确认: 状态稳定
    消抖中 --> 空闲: 状态恢复
    按下确认 --> 长按检测: 500ms计时
    长按检测 --> 长按触发: 500ms到达
    长按检测 --> 短按触发: 释放按键
    长按触发 --> 长按保持: 持续按下
    长按保持 --> 重复触发: 每200ms
    短按触发 --> 空闲
    长按触发 --> 空闲: 释放按键
    重复触发 --> 空闲: 释放按键
```

### 7. 主应用层模块 (app_moto_lights)

#### 功能描述

系统协调器，管理各模块初始化、事件处理、状态监控。

#### 系统状态

```mermaid
stateDiagram-v2
    [*] --> 初始化
    初始化 --> 正常运行: 初始化完成
    正常运行 --> 低电量: 电池电压 < 11V
    正常运行 --> 错误状态: 系统错误
    正常运行 --> 测试模式: 按键触发
    低电量 --> 正常运行: 电池电压恢复
    错误状态 --> 正常运行: 错误清除
    测试模式 --> 正常运行: 按键退出
```

#### 事件处理流程

```mermaid
flowchart TD
    EVENT[事件触发]
    KEY_EVENT{按键事件?}
    SIGNAL_EVENT{信号事件?}
    KEY_HANDLER[按键事件处理]
    SIGNAL_HANDLER[信号事件处理]
    SCENE_UPDATE[更新场景状态]
    STATE_UPDATE[更新系统状态]
    
    EVENT --> KEY_EVENT
    KEY_EVENT -->|是| KEY_HANDLER
    KEY_EVENT -->|否| SIGNAL_EVENT
    
    SIGNAL_EVENT -->|是| SIGNAL_HANDLER
    SIGNAL_EVENT -->|否| STATE_UPDATE
    
    KEY_HANDLER --> SCENE_UPDATE
    SIGNAL_HANDLER --> SCENE_UPDATE
    SCENE_UPDATE --> STATE_UPDATE
```

---

## 数据流

### 信号到灯光的完整数据流

```mermaid
flowchart LR
    subgraph "输入"
        SIG[原车信号<br/>P0.0-P0.5]
        KEY[按键输入<br/>P3.2/P3.6/P3.7]
        ADC[传感器<br/>P0.6/P0.7]
    end
    
    subgraph "处理"
        VS[信号检测<br/>消抖/边沿]
        KEY_P[按键处理<br/>短按/长按]
        SEN[传感器处理<br/>滤波/转换]
        SCHED[优先级调度<br/>场景选择]
        RENDER[场景渲染<br/>效果生成]
    end
    
    subgraph "输出"
        WS[WS2812B<br/>90颗LED]
        RGB[RGB灯组<br/>3路PWM]
        BRAKE[刹车灯<br/>PWM]
        BUZZER[蜂鸣器<br/>PWM]
        LED[状态LED<br/>GPIO]
    end
    
    SIG --> VS
    KEY --> KEY_P
    ADC --> SEN
    
    VS --> SCHED
    KEY_P --> SCHED
    SEN --> SCHED
    
    SCHED --> RENDER
    
    RENDER --> WS
    RENDER --> RGB
    RENDER --> BRAKE
    RENDER --> BUZZER
    RENDER --> LED
```

### 场景渲染数据流

```mermaid
flowchart TD
    SCENE[场景激活]
    GET_PRIORITY[获取场景优先级]
    CHECK_MAX{是否为<br/>最高优先级?}
    GET_EFFECT[获取场景效果参数]
    CALC_COLOR[计算颜色值]
    APPLY_BRIGHTNESS[应用亮度]
    UPDATE_WS2812B[更新WS2812B缓冲区]
    UPDATE_PWM[更新PWM占空比]
    SEND_DATA[发送数据到硬件]
    
    SCENE --> GET_PRIORITY
    GET_PRIORITY --> CHECK_MAX
    CHECK_MAX -->|是| GET_EFFECT
    CHECK_MAX -->|否| WAIT[等待]
    GET_EFFECT --> CALC_COLOR
    CALC_COLOR --> APPLY_BRIGHTNESS
    APPLY_BRIGHTNESS --> UPDATE_WS2812B
    APPLY_BRIGHTNESS --> UPDATE_PWM
    UPDATE_WS2812B --> SEND_DATA
    UPDATE_PWM --> SEND_DATA
```

---

## 性能指标

### 任务执行时间分析

| 任务名称 | 周期 | 平均执行时间 | CPU占用率 | 说明 |
|---------|------|------------|----------|------|
| Sample_VehicleSignal | 10ms | < 0.5ms | < 5% | 信号检测和消抖 |
| Sample_PWM_Output | 10ms | < 0.3ms | < 3% | PWM输出更新 |
| Sample_LightScheduler | 20ms | < 2ms | < 10% | 场景调度和渲染 |
| Sample_MotoLights_App | 50ms | < 1ms | < 2% | 主应用逻辑 |
| Sample_Sensors | 100ms | < 1ms | < 1% | 传感器采样 |
| Sample_StatusIndicator | 100ms | < 0.1ms | < 0.1% | 状态LED控制 |
| Sample_intKey | 10ms | < 0.2ms | < 2% | 按键扫描 |
| CPUMonitor_Calculate | 1000ms | < 0.5ms | < 0.05% | CPU监控 |
| TaskMonitor_PrintReport | 5000ms | < 1ms | < 0.02% | 任务监控报告 |

### 响应时间分析

```mermaid
gantt
    title 系统响应时间分析
    dateFormat X
    axisFormat %L ms
    
    section 信号检测到灯光响应
    信号输入 :0, 1
    信号采样 :0, 10
    消抖处理 :10, 20
    边沿检测 :30, 1
    回调触发 :31, 1
    场景激活 :32, 1
    场景渲染 :33, 2
    灯光更新 :35, 5
    总计响应时间 :0, 40
    
    section 按键检测到功能响应
    按键按下 :0, 1
    中断触发 :0, 1
    消抖确认 :1, 20
    事件识别 :21, 1
    回调触发 :22, 1
    功能执行 :23, 2
    总计响应时间 :0, 25
```

### CPU占用率分析

```mermaid
pie title CPU占用率分布（正常运行时）
    "任务执行" : 25
    "中断处理" : 3
    "空闲" : 72
```

### 内存使用分析

| 模块 | RAM使用 | 说明 |
|------|---------|------|
| WS2812B缓冲区 | 270字节 | 90颗LED × 3字节 |
| 任务调度器 | 50字节 | 场景状态和优先级 |
| 信号检测 | 30字节 | 信号状态和消抖 |
| 传感器数据 | 40字节 | 采样数据和滤波 |
| 系统信息 | 20字节 | 系统状态和运行时间 |
| 其他 | 100字节 | 临时变量和栈 |
| **总计** | **~510字节** | 约占总RAM的12% |

---

## 总结

### 系统特点

1. **模块化设计**：各功能模块独立，接口清晰，便于维护和扩展
2. **事件驱动**：基于回调机制，响应及时，资源占用低
3. **优先级调度**：确保安全功能（如刹车）的最高优先级
4. **实时性保证**：任务周期设计合理，响应时间 < 50ms
5. **可扩展性强**：预留接口支持后续功能增强

### 技术亮点

- ✅ 协作式多任务调度，基于1ms时基
- ✅ 优先级场景调度机制，自动切换
- ✅ 多种灯光效果，支持区域控制
- ✅ 环境光自适应，白天/夜晚模式自动切换
- ✅ 完善的监控系统，CPU和任务性能分析
- ✅ 看门狗保护，防止系统死锁

### 应用场景

- 摩托车智能灯光系统
- 电动车氛围灯控制
- 汽车装饰灯光系统
- 其他需要多场景灯光控制的场合

---

**文档版本：** V1.0  
**最后更新：** 2025-11-17  
**文档状态：** ✅ 完整可用

