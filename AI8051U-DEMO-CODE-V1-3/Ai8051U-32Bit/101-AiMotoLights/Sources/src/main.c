/*---------------------------------------------------------------------*/
/* --- Web: www.STCAI.com ---------------------------------------------*/
/*---------------------------------------------------------------------*/

#include "Task.h"
#include "System_init.h"
#include "../USBHID/usb.h"

//========================================================================
// 集成独立监控插件（可选）
//========================================================================
#include "TaskMonitor/TaskMonitor.h"   // 任务性能监控
#include "CPUMonitor/CPUMonitor.h"     // CPU占用率监控

//USB调试及复位所需定义
char *USER_DEVICEDESC = NULL;
char *USER_PRODUCTDESC = NULL;
char *USER_STCISPCMD = "@STCISP#";                      //设置自动复位到ISP区的用户接口命令

/*************	功能说明	**************

本例程基于AI8051U为主控芯片的实验箱进行编写测试。

使用Timer0的16位自动重装来产生1ms节拍，程序使用这个节拍进行任务调度.

每个任务设置相应的调度周期，根据设置的周期时间执行任务函数.

1. 左边4位LED显示时间(小时,分钟).
2. 右边4位数码管显示温度值, 分辨率0.1度.
3. 矩阵键盘扫描，按一个按键蜂鸣器响一下.
4. ADC按键 “0”：小时+； “1”：小时-； “2”：分钟+； “3”：分钟-；

下载时, 选择时钟 24MHz (可以在配置文件"config.h"中修改).

******************************************/

//========================================================================
// 函数: int main(void)
// 描述: 主函数程序.
// 参数: None.
// 返回: int.
// 版本: V1.0, 2022-05-26
//========================================================================
int main(void)
{
    WTST = 0;  //设置程序指令延时参数，赋值为0可将CPU执行指令的速度设置为最快
    EAXFR = 1; //扩展寄存器(XFR)访问使能
    CKCON = 0; //提高访问XRAM速度

    SYS_Init();
    usb_init();  //USB初始化

    //========================================================================
    // 优化4：初始化TaskMonitor插件（任务性能监控）
    //========================================================================
    TaskMonitor_Init();
    
    // 设置各任务的周期（用于超时检测）
    // 注意：索引必须与Task.c中的任务顺序一致
    TaskMonitor_SetPeriod(0, 10);     // Sample_VehicleSignal, 10ms
    TaskMonitor_SetPeriod(1, 10);     // Sample_PWM_Output, 10ms
    TaskMonitor_SetPeriod(2, 20);     // Sample_LightScheduler, 20ms
    TaskMonitor_SetPeriod(3, 50);     // Sample_MotoLights_App, 50ms
    TaskMonitor_SetPeriod(4, 100);    // Sample_Sensors, 100ms
    TaskMonitor_SetPeriod(5, 100);    // Sample_StatusIndicator, 100ms
#if ENABLE_INT_KEY
    TaskMonitor_SetPeriod(6, 10);    // Sample_intKey, 10ms
    TaskMonitor_SetPeriod(7, 1000);   // CPUMonitor_Calculate, 1000ms
    TaskMonitor_SetPeriod(8, 5000);   // TaskMonitor_PrintReport, 5000ms
    TaskMonitor_SetPeriod(9, 5000);   // CPUMonitor_PrintReport, 5000ms
    TaskMonitor_SetPeriod(10, 1);     // Sample_USB_Debug, 1ms
#else
    TaskMonitor_SetPeriod(6, 1000);   // CPUMonitor_Calculate, 1000ms
    TaskMonitor_SetPeriod(7, 5000);   // TaskMonitor_PrintReport, 5000ms
    TaskMonitor_SetPeriod(8, 5000);   // CPUMonitor_PrintReport, 5000ms
    TaskMonitor_SetPeriod(9, 1);      // Sample_USB_Debug, 1ms
#endif

    //========================================================================
    // 优化6：初始化CPUMonitor插件（CPU占用率监控）
    //========================================================================
    CPUMonitor_Init();

    //========================================================================
    // 优化1+5：启用看门狗保护（防止系统死锁）
    // 注意：看门狗使用独立的内部IRC时钟，不受MAIN_Fosc影响
    //========================================================================
    // 看门狗超时时间可选配置（任选其一，根据需求）：
    //
    // WDT_CONTR = 0x05;  // 预分频2,   溢出时间约 7.8ms   (极短，快速故障恢复)
    // WDT_CONTR = 0x15;  // 预分频4,   溢出时间约 15.6ms  (短，实时控制系统)
    // WDT_CONTR = 0x25;  // 预分频8,   溢出时间约 31.3ms  (较短，高速任务)
    // WDT_CONTR = 0x35;  // 预分频256, 溢出时间约 1秒     (推荐，一般应用) ⭐
    // WDT_CONTR = 0x37;  // 预分频256+延长, 溢出时间约 2秒 (长，复杂任务)
    //
    // 重要说明：
    //   - 看门狗使用独立的内部低速IRC（~32kHz），不受主时钟MAIN_Fosc影响
    //   - 因此48MHz和24MHz下，看门狗超时时间相同
    //   - 溢出时间 = (预分频 × 256) / (看门狗IRC频率)
    //   - 当前48MHz主频，主循环执行更快，安全裕量更大 ✅
    //========================================================================
    WDT_CONTR = 0x35;  // 当前配置：1秒超时（推荐）

    while (1)
    {
        //====================================================================
        // 优化1：喂狗操作（防止看门狗复位）
        // 必须在1秒内至少执行一次，否则系统自动复位
        //====================================================================
        WDT_CONTR |= 0x10;  // 清除看门狗计数器

        //====================================================================
        // USB 数据接收处理
        //====================================================================
        if (bUsbOutReady)
        {
            usb_OUT_done(); //接收应答（固定格式）
        }

        Task_Pro_Handler_Callback();
        
        //====================================================================
        // 优化6：CPUMonitor插件钩子 - 空闲计数
        // 开销：1条指令 (~20ns @ 48MHz)，CPU影响<0.001%
        //====================================================================
        CPU_MONITOR_IDLE_TICK();
    }

    return 0; // 永远不会执行到这里
}
