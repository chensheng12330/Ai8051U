# 6è·¯å‘¼å¸ç¯å¿«é€Ÿé›†æˆæŒ‡å—

## ä¸€ã€ä¿®æ”¹æ­¥éª¤æ¦‚è§ˆ

```
åŸé¡¹ç›® (5ä¸ªä»»åŠ¡)                    æ–°é¡¹ç›® (3ä¸ªä»»åŠ¡)
â”œâ”€ Sample_Display     (1ms)   â†’   Sample_BreathLED      (20ms)
â”œâ”€ Sample_MatrixKey   (10ms)  â†’   Sample_BreathControl  (50ms)
â”œâ”€ Sample_adcKey      (10ms)  â†’   Sample_Status         (500ms)
â”œâ”€ Sample_NTC         (300ms)      (åˆ é™¤)
â””â”€ Sample_RTC         (500ms)      (åˆ é™¤)
```

---

## äºŒã€è¯¦ç»†ä¿®æ”¹æ­¥éª¤

### æ­¥éª¤1ï¼šä¿®æ”¹ `Task.c`

**ä½ç½®ï¼š** `Sources/src/Task.c`

**ä¿®æ”¹å‰ï¼š**
```c
static TASK_COMPONENTS Task_Comps[]=
{
    {0, 1,   1,   Sample_Display},      
    {0, 10,  10,  Sample_MatrixKey},    
    {0, 10,  10,  Sample_adcKey},       
    {0, 300, 300, Sample_NTC},          
    {0, 500, 500, Sample_RTC},          
};
```

**ä¿®æ”¹åï¼š**
```c
static TASK_COMPONENTS Task_Comps[]=
{
    {0, 20,  20,  Sample_BreathLED},      /* å‘¼å¸ç¯ä»»åŠ¡ï¼Œ20mså‘¨æœŸ */
    {0, 50,  50,  Sample_BreathControl},  /* æ§åˆ¶ä»»åŠ¡ï¼Œ50mså‘¨æœŸ */
    {0, 500, 500, Sample_Status},         /* çŠ¶æ€æ˜¾ç¤ºï¼Œ500mså‘¨æœŸ */
};
```

---

### æ­¥éª¤2ï¼šä¿®æ”¹ `Task.h`

**ä½ç½®ï¼š** `Sources/inc/Task.h`

**æ·»åŠ å‡½æ•°å£°æ˜ï¼š**
```c
#ifndef __TASK_H_
#define __TASK_H_

#include "config.h"

typedef struct 
{
    u8 Run;
    u16 TIMCount;
    u16 TRITime;
    void (*TaskHook) (void);
} TASK_COMPONENTS;

// æ–°å¢ï¼šå‘¼å¸ç¯ä»»åŠ¡å‡½æ•°å£°æ˜
void Task_Marks_Handler_Callback(void);
void Task_Pro_Handler_Callback(void);

#endif
```

---

### æ­¥éª¤3ï¼šåˆ›å»º `app_BreathLED.h`

**ä½ç½®ï¼š** `Sources/inc/app_BreathLED.h`

```c
#ifndef __APP_BREATHLED_H_
#define __APP_BREATHLED_H_

#include "config.h"

//========================================================================
//                            å‘¼å¸ç¯æ¨¡å¼å®šä¹‰
//========================================================================

typedef enum {
    MODE_SYNC = 0,     // åŒæ­¥æ¨¡å¼
    MODE_WAVE,         // æ³¢æµªæ¨¡å¼
    MODE_RANDOM,       // éšæœºæ¨¡å¼
    MODE_BREATH_FAST,  // å¿«é€Ÿå‘¼å¸
    MODE_BREATH_SLOW,  // æ…¢é€Ÿå‘¼å¸
    MODE_MARQUEE,      // è·‘é©¬ç¯
    MODE_MAX
} BREATH_MODE;

//========================================================================
//                            å‡½æ•°å£°æ˜
//========================================================================

void BreathLED_Init(void);
void BreathLED_SetMode(u8 mode);
void Sample_BreathLED(void);
void Sample_BreathControl(void);
void Sample_Status(void);

#endif
```

---

### æ­¥éª¤4ï¼šåˆ›å»º `app_BreathLED.c`

**ä½ç½®ï¼š** `Sources/src/app_BreathLED.c`

**å†…å®¹ï¼š** (è§ `ç¤ºä¾‹-6è·¯å‘¼å¸ç¯å®ç°.c` æ–‡ä»¶)

---

### æ­¥éª¤5ï¼šä¿®æ”¹ `app.h`

**ä½ç½®ï¼š** `app.h`

**ä¿®æ”¹å‰ï¼š**
```c
#ifndef __APP_H_
#define __APP_H_

#include "app_Display.h"
#include "app_MatrixKey.h"
#include "app_adcKey.h"
#include "app_ntc.h"
#include "app_rtc.h"

void APP_config(void);

#endif
```

**ä¿®æ”¹åï¼š**
```c
#ifndef __APP_H_
#define __APP_H_

#include "app_BreathLED.h"  // æ–°å¢

void APP_config(void);

#endif
```

---

### æ­¥éª¤6ï¼šä¿®æ”¹ `app.c`

**ä½ç½®ï¼š** `Sources/src/app.c`

**ä¿®æ”¹å‰ï¼š**
```c
void APP_config(void)
{
    Display_init();
    RTC_init();
    adcKey_init();
}
```

**ä¿®æ”¹åï¼š**
```c
void APP_config(void)
{
    BreathLED_Init();  // åˆå§‹åŒ–å‘¼å¸ç¯
}
```

---

### æ­¥éª¤7ï¼šä¿®æ”¹ `System_init.c` (PWMé…ç½®)

**ä½ç½®ï¼š** `Sources/src/System_init.c`

**åœ¨ `PWM_config()` å‡½æ•°ä¸­ä¿®æ”¹ï¼š**

```c
void PWM_config(void)
{
    //------ PWMAé…ç½® (PWM1-4) ------
    PWMA_CCER1 = 0x00;
    PWMA_CCER2 = 0x00;
    
    PWMA_CCMR1 = 0x68;  // CH1,2 PWMæ¨¡å¼1
    PWMA_CCMR2 = 0x68;
    PWMA_CCMR3 = 0x68;  // CH3,4 PWMæ¨¡å¼1
    PWMA_CCMR4 = 0x68;
    
    PWMA_CCER1 = 0x11;  // CH1,2ä½¿èƒ½
    PWMA_CCER2 = 0x11;  // CH3,4ä½¿èƒ½
    
    PWMA_ARRH = 0x07;   // ARR=2047
    PWMA_ARRL = 0xFF;
    
    PWMA_CCR1H = 0; PWMA_CCR1L = 0;
    PWMA_CCR2H = 0; PWMA_CCR2L = 0;
    PWMA_CCR3H = 0; PWMA_CCR3L = 0;
    PWMA_CCR4H = 0; PWMA_CCR4L = 0;
    
    PWMA_ENO = 0x0F;    // PWM1-4è¾“å‡ºä½¿èƒ½
    PWMA_PS = 0x00;     // é»˜è®¤å¼•è„š
    PWMA_BKR = 0x80;
    PWMA_CR1 = 0x81;
    
    //------ PWMBé…ç½® (PWM5-6) ------
    PWMB_CCER1 = 0x00;
    
    PWMB_CCMR1 = 0x68;
    PWMB_CCMR2 = 0x68;
    
    PWMB_CCER1 = 0x11;
    
    PWMB_ARRH = 0x07;
    PWMB_ARRL = 0xFF;
    
    PWMB_CCR1H = 0; PWMB_CCR1L = 0;
    PWMB_CCR2H = 0; PWMB_CCR2L = 0;
    
    PWMB_ENO = 0x03;
    PWMB_PS = 0x00;
    PWMB_BKR = 0x80;
    PWMB_CR1 = 0x81;
}
```

---

### æ­¥éª¤8ï¼šä¿®æ”¹ `GPIO_config()` (IOé…ç½®)

**ä½ç½®ï¼š** `Sources/src/System_init.c`

```c
void GPIO_config(void)
{
    // PWMå¼•è„šé…ç½®ä¸ºæ¨æŒ½è¾“å‡º
    P0M1 = 0x00;   P0M0 = 0x00;
    P1M1 = 0x00;   P1M0 = 0x0F;   // P1.0-P1.3 æ¨æŒ½è¾“å‡º (PWM1-4)
    P2M1 = 0x00;   P2M0 = 0x03;   // P2.0-P2.1 æ¨æŒ½è¾“å‡º (PWM5-6)
    P3M1 = 0x00;   P3M0 = 0x00;
    P4M1 = 0x00;   P4M0 = 0x00;
    P5M1 = 0x00;   P5M0 = 0x00;
    P6M1 = 0x00;   P6M0 = 0x00;
    P7M1 = 0x00;   P7M0 = 0x00;
}
```

---

### æ­¥éª¤9ï¼šä¿®æ”¹ `main.c`

**ä½ç½®ï¼š** `Sources/src/main.c`

**æ— éœ€ä¿®æ”¹ï¼** ä¸»å¾ªç¯ä¿æŒä¸å˜ï¼š

```c
void main(void)
{
    WTST = 0;
    EAXFR = 1;
    CKCON = 0;

    SYS_Init();  // ä¼šè°ƒç”¨APP_config() â†’ BreathLED_Init()

    while (1)
    {
        Task_Pro_Handler_Callback();  // è‡ªåŠ¨è°ƒåº¦æ‰€æœ‰ä»»åŠ¡
    }
}
```

---

## ä¸‰ã€å¼•è„šè¿æ¥è¯´æ˜

### PWMè¾“å‡ºå¼•è„š

| PWMé€šé“ | é»˜è®¤å¼•è„š | å¯é€‰å¼•è„š (é€šè¿‡PWMA/B_PSåˆ‡æ¢) |
|---------|----------|------------------------------|
| PWM1    | P1.0     | P6.0, P2.0                   |
| PWM2    | P1.1     | P6.1, P2.1                   |
| PWM3    | P1.2     | P6.2, P2.2                   |
| PWM4    | P1.3     | P6.3, P2.3                   |
| PWM5    | P2.0     | P6.4, P7.4                   |
| PWM6    | P2.1     | P6.5, P7.5                   |

### LEDè¿æ¥æ–¹å¼

```
æ–¹å¼1ï¼šå…±é˜´æ (æ¨è)
MCU PWMå¼•è„š â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€ LEDæ­£æ(+)
                  â”‚
                 LED
                  â”‚
                GND â”€â”€â”€â”€ LEDè´Ÿæ(-)

æ–¹å¼2ï¼šå…±é˜³æ
VCC â”€â”€â”€â”€ LEDæ­£æ(+)
          â”‚
         LED
          â”‚
MCU PWMå¼•è„š â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€ LEDè´Ÿæ(-)
```

**æ³¨æ„ï¼š** å¦‚æœä½¿ç”¨å¤§åŠŸç‡LEDï¼Œéœ€è¦æ·»åŠ ä¸‰æç®¡/MOSç®¡é©±åŠ¨ï¼

---

## å››ã€ç¼–è¯‘é…ç½®

### Keil uVision5 é¡¹ç›®é…ç½®

1. **æ·»åŠ æºæ–‡ä»¶åˆ°é¡¹ç›®ï¼š**
   ```
   Sources/src/app_BreathLED.c
   ```

2. **æ·»åŠ å¤´æ–‡ä»¶è·¯å¾„ï¼š**
   ```
   Project â†’ Options â†’ C/C++ â†’ Include Paths
   æ·»åŠ : Sources/inc
   ```

3. **ç¼–è¯‘è®¾ç½®ï¼š**
   - Target: AI8051U
   - Crystal: 24.000000 MHz
   - Memory Model: Small
   - Code Optimization: Level 9

---

## äº”ã€è°ƒè¯•ä¸æµ‹è¯•

### 5.1 ä¸²å£è°ƒè¯•è¾“å‡º

è¿æ¥USBè½¬TTLæ¨¡å—ï¼ˆ115200bpsï¼‰ï¼š
```
AI8051U P3.0 (TXD) â”€â”€> USB-TTL RXD
AI8051U P3.1 (RXD) â”€â”€> USB-TTL TXD
AI8051U GND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> USB-TTL GND
```

**é¢„æœŸè¾“å‡ºï¼š**
```
========================================
  6-Channel Breath LED Demo
  Based on Task Scheduler System
========================================
PWM BreathLED Init OK
BreathLED Init OK
Mode Changed: 1
Status [0] Mode=1, Brightness=255
LED:    0  340  680 1020 1360 1700
Status [1] Mode=1, Brightness=255
LED:   15  355  695 1035 1375 1715
...
```

### 5.2 åŠŸèƒ½æµ‹è¯•

| æµ‹è¯•é¡¹ | éªŒè¯æ–¹æ³• | é¢„æœŸç»“æœ |
|--------|----------|----------|
| æ³¢æµªæ¨¡å¼ | ä¸Šç”µé»˜è®¤ | 6ä¸ªLEDä¾æ¬¡æ¸äº®æ¸æš— |
| åŒæ­¥æ¨¡å¼ | æŒ‰é”®åˆ‡æ¢ | 6ä¸ªLEDåŒæ­¥å‘¼å¸ |
| äº®åº¦è°ƒèŠ‚ | æŒ‰é”®+/- | æ•´ä½“äº®åº¦å˜åŒ– |
| CPUå ç”¨ | ä¸²å£è¾“å‡º | <10% |
| åˆ·æ–°ç‡ | ç¤ºæ³¢å™¨æµ‹é‡ | 50Hz (æ— é—ªçƒ) |

### 5.3 æ€§èƒ½ç›‘æ§

**æ·»åŠ æ€§èƒ½ç›‘æ§ä»£ç ï¼ˆå¯é€‰ï¼‰ï¼š**

```c
void Sample_Status(void)
{
    static u32 loop_count = 0;
    static u16 last_count = 0;
    u16 loops_per_sec;
    
    loops_per_sec = loop_count - last_count;
    last_count = loop_count;
    
    printf("Loop/s: %u, CPU: %d%%\r\n", 
           loops_per_sec, 
           100 - (loops_per_sec / 10000));  // ç²—ç•¥ä¼°ç®—
}

// åœ¨ä¸»å¾ªç¯ä¸­
void main(void)
{
    while(1)
    {
        Task_Pro_Handler_Callback();
        loop_count++;  // æ·»åŠ è¿™è¡Œ
    }
}
```

---

## å…­ã€å¸¸è§é—®é¢˜

### Q1: LEDä¸äº®ï¼Ÿ

**æ£€æŸ¥æ¸…å•ï¼š**
1. âœ… PWMå¼•è„šé…ç½®ä¸ºæ¨æŒ½è¾“å‡º (`PxM0=1, PxM1=0`)
2. âœ… PWMè¾“å‡ºä½¿èƒ½ (`PWMA_ENO`, `PWMB_ENO`)
3. âœ… ä¸»è¾“å‡ºä½¿èƒ½ (`PWMA_BKR=0x80`)
4. âœ… LEDææ€§æ­£ç¡®ï¼ˆå…±é˜´/å…±é˜³ï¼‰
5. âœ… ç”µæºç”µå‹è¶³å¤Ÿï¼ˆå»ºè®®5Vï¼‰

### Q2: LEDé—ªçƒä¸æµç•…ï¼Ÿ

**åŸå› ï¼š** PWMé¢‘ç‡å¤ªä½æˆ–ä»»åŠ¡å‘¨æœŸå¤ªé•¿

**è§£å†³ï¼š**
```c
// æé«˜PWMé¢‘ç‡
PWMA_ARRH = 0x03;  // ARR=1023, é¢‘ç‡=24MHz/1024â‰ˆ23.4kHz
PWMA_ARRL = 0xFF;

// ç¼©çŸ­ä»»åŠ¡å‘¨æœŸ
{0, 10, 10, Sample_BreathLED},  // 20msâ†’10ms
```

### Q3: 6è·¯LEDä¸åŒæ­¥ï¼Ÿ

**æ­£å¸¸ç°è±¡ï¼** æ³¢æµªæ¨¡å¼ä¸‹æœ‰ç›¸ä½å·®ï¼Œåˆ‡æ¢åˆ°åŒæ­¥æ¨¡å¼ï¼š

```c
BreathLED_SetMode(MODE_SYNC);
```

### Q4: å¦‚ä½•è°ƒèŠ‚å‘¼å¸é€Ÿåº¦ï¼Ÿ

**ä¿®æ”¹é€Ÿåº¦å‚æ•°ï¼š**
```c
breath_leds[i].speed = 20;  // è¶Šå¤§è¶Šå¿«ï¼ˆ1-50ï¼‰
```

### Q5: å¦‚ä½•å®ç°éçº¿æ€§äº®åº¦ï¼ˆæ›´æŸ”å’Œï¼‰ï¼Ÿ

**æ·»åŠ Gammaæ ¡æ­£è¡¨ï¼š**

```c
// 2.2 Gammaæ ¡æ­£è¡¨
u16 code gamma_table[256] = {
    0, 0, 0, 0, 1, 1, 1, 2, 2, 3, 3, 4, 5, 6, 7, 8,
    9, 10, 12, 13, 15, 16, 18, 20, 22, 24, 26, 28, 31, 33, 36, 38,
    // ... (çœç•¥ä¸­é—´å€¼)
    1920, 1968, 2016, 2047
};

// åœ¨SetPWM_Dutyå‰æŸ¥è¡¨
duty = gamma_table[brightness >> 3];  // brightness: 0-2047 â†’ 0-255
SetPWM_Duty(i+1, duty);
```

---

## ä¸ƒã€è¿›é˜¶æ‰©å±•

### æ‰©å±•1: æ·»åŠ RGBå½©è™¹æ•ˆæœ

**ä½¿ç”¨WS2812æ›¿ä»£PWMï¼š**

```c
// ä»»åŠ¡é…ç½®
{0, 50, 50, Sample_WS2812},  // 50msåˆ·æ–° (20fps)

// WS2812ä»»åŠ¡
void Sample_WS2812(void)
{
    static u16 hue = 0;
    u8 i;
    
    for(i=0; i<6; i++)
    {
        RGB_Buffer[i] = HSV_to_RGB((hue + i*60) % 360, 255, 255);
    }
    
    WS2812_Send_DMA(RGB_Buffer, 6);
    hue += 2;
}
```

**å‚è€ƒé¡¹ç›®ï¼š** `80-SPI-DMAå‘é€-é©±åŠ¨WS2812å½©ç¯`

### æ‰©å±•2: éŸ³ä¹å¾‹åŠ¨

**æ·»åŠ ADCéº¦å…‹é£è¾“å…¥ï¼š**

```c
void Sample_MusicSync(void)
{
    u16 volume = Get_ADC12bitResult(0);  // éº¦å…‹é£ADC
    
    // æ ¹æ®éŸ³é‡è°ƒèŠ‚äº®åº¦
    global_brightness = volume >> 4;  // 0-4095 â†’ 0-255
}
```

### æ‰©å±•3: å…‰æ•è‡ªåŠ¨è°ƒèŠ‚

```c
void Sample_AutoBrightness(void)
{
    u16 light = Get_ADC12bitResult(1);  // å…‰æ•ç”µé˜»ADC
    
    // æš—æ—¶è‡ªåŠ¨å˜äº®
    if(light < 1000)
        global_brightness = 255;
    else if(light > 3000)
        global_brightness = 50;
    else
        global_brightness = 255 - (light - 1000) / 10;
}
```

---

## å…«ã€æ€»ç»“

### âœ… ä¼˜åŠ¿

1. **ä»£ç å¤ç”¨æ€§é«˜** - ä»»åŠ¡è°ƒåº¦æ¡†æ¶æ— éœ€ä¿®æ”¹
2. **æ‰©å±•æ€§å¼º** - è½»æ¾æ·»åŠ æ–°æ¨¡å¼å’ŒåŠŸèƒ½
3. **æ€§èƒ½ä¼˜ç§€** - CPUå ç”¨<10%ï¼Œå“åº”å¿«é€Ÿ
4. **æ˜“äºè°ƒè¯•** - ä¸²å£å®æ—¶è¾“å‡ºçŠ¶æ€

### ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| ä»»åŠ¡å‘¨æœŸ | 20ms (50Hz) |
| CPUå ç”¨ | 6-8% |
| RAMå ç”¨ | ~100B |
| Flashå ç”¨ | ~3KB |
| å“åº”å»¶è¿Ÿ | <50ms |

### ğŸ¯ é€‚ç”¨åœºæ™¯

- âœ… è£…é¥°ç¯å…‰
- âœ… æ°›å›´ç¯
- âœ… çŠ¶æ€æŒ‡ç¤ºç¯
- âœ… æ™ºèƒ½å®¶å±…ç¯å…‰
- âœ… æ•™å­¦æ¼”ç¤º

---

**ç¥æ‚¨å¼€å‘é¡ºåˆ©ï¼** å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ä¸²å£è°ƒè¯•è¾“å‡ºæˆ–å‚è€ƒåŸé¡¹ç›®ä»£ç ã€‚

