# AI8051U 项目结构详细说明

本文档详细说明AI8051U演示代码库的完整目录结构和文件组织方式。

---

## 总体目录结构

```
AI8051U-DEMO-CODE-V1-3/
├── README.md                          # 项目总览文档
├── 功能分类索引.md                     # 按功能分类的详细索引
├── 示例详细清单.md                     # 所有示例的详细功能表格
├── 项目结构说明.md                     # 本文档
│
└── Ai8051U-32Bit/                     # 32位模式示例代码主目录
    ├── COMM/                          # 公共库文件目录
    │   ├── AI8051U.H                  # 芯片寄存器定义头文件
    │   ├── AI8051U.INC                # 汇编语言包含文件
    │   ├── usb_cdc_32.LIB             # USB CDC协议库文件
    │   ├── usb_hid_32.LIB             # USB HID协议库文件
    │   └── usb.h                      # USB通用头文件
    │
    ├── 01-用P0口做跑马灯/               # 示例01（基础IO）
    ├── 02-Timer0-Timer1-Timer2-Timer3-Timer4测试程序/  # 示例02（定时器）
    ├── ...                            # 其他示例（03-26）
    ├── 27-通过定时器周期性调度任务综合例程，简单实用的任务调度系统，推荐/
    ├── ...                            # 示例28-39
    ├── 41-内部RTC时钟程序-使用外部32768晶振，才能保证RTC精度/
    ├── 42-USB-HID(Human Interface Device)协议范例/
    ├── ...                            # 示例43-52（USB系列）
    ├── 56-LIN总线从机收发测试-USART1/
    ├── ...                            # 示例57-59（LIN总线）
    ├── 60-DMA-ADC采样数据自动存储/
    ├── ...                            # 示例61-72（DMA系列）
    ├── 73-频谱分析256点FFT-USB-CDC送电脑ISP软件调试接口FFT绘图显示/
    ├── ...                            # 示例74-87（高级应用）
    ├── A01-如发现P32按键接地用户程序就软复位到系统区不停电下载/
    ├── A02-电脑端的ISP软件通过USB-CDC发送命令通知MCU软复位到系统区不停电下载/
    ├── A03-电脑端的ISP软件通过USB-HID发送命令通知MCU软复位到系统区不停电下载/
    └── A04-电脑端的ISP软件通过UART发送命令通知MCU软复位到系统区不停电下载/
```

---

## COMM 公共库目录详解

### AI8051U.H - 芯片寄存器定义头文件

**文件作用**：定义AI8051U系列所有特殊功能寄存器（SFR）和位变量（sbit）

**文件大小**：约1400行

**主要内容**：

#### 1. 基础寄存器（8051标准）
```c
// 端口寄存器
sfr P0 = 0x80;
sfr P1 = 0x90;
sfr P2 = 0xA0;
sfr P3 = 0xB0;
sfr P4 = 0xC0;
sfr P5 = 0xC8;
sfr P6 = 0xE8;
sfr P7 = 0xF8;

// 位变量
sbit P00 = P0^0;
sbit P01 = P0^1;
// ...

// 定时器
sfr TCON = 0x88;
sfr TMOD = 0x89;
sfr TL0 = 0x8A;
sfr TH0 = 0x8C;
// ...

// 串口
sfr SCON = 0x98;
sfr SBUF = 0x99;

// 中断
sfr IE = 0xA8;
sfr IP = 0xB8;
```

#### 2. 端口模式配置寄存器
```c
// 每个端口有两个模式寄存器：PnM1和PnM0
sfr P0M1 = 0x93;   // P0模式寄存器1
sfr P0M0 = 0x94;   // P0模式寄存器0

// 端口模式配置：
// PnM1  PnM0  模式
//  0     0    准双向口
//  0     1    推挽输出
//  1     0    高阻输入
//  1     1    开漏输出
```

#### 3. 扩展定时器（Timer2-4）
```c
sfr T2H = 0xD6;
sfr T2L = 0xD7;
sfr T3H = 0xD2;
sfr T3L = 0xD3;
sfr T4H = 0xD4;
sfr T4L = 0xD5;
```

#### 4. 扩展串口（UART2-4）
```c
sfr S2CON = 0x9A;
sfr S2BUF = 0x9B;
sfr S3CON = 0xAC;
sfr S3BUF = 0xAD;
sfr S4CON = 0x84;
sfr S4BUF = 0x85;
```

#### 5. ADC相关寄存器
```c
sfr ADC_CONTR = 0xBC;   // ADC控制寄存器
sfr ADC_RES = 0xBD;     // ADC结果高8位
sfr ADC_RESL = 0xBE;    // ADC结果低4位
sfr ADCCFG = 0xDE;      // ADC配置
```

#### 6. PWM相关寄存器
```c
// PCA-PWM
sfr CCON = 0xD8;
sfr CMOD = 0xD9;
sfr CCAPM0 = 0xDA;
// ...

// 高级PWM
sfr PWMCFG = 0xF1;
sfr PWM1T1 = 0xF2;
sfr PWM1T2 = 0xF3;
// ...
```

#### 7. SPI相关寄存器
```c
sfr SPSTAT = 0xCD;      // SPI状态
sfr SPCTL = 0xCE;       // SPI控制
sfr SPDAT = 0xCF;       // SPI数据
```

#### 8. I2C相关寄存器
```c
sfr I2CCFG = 0x98;      // I2C配置
sfr I2CMSCR = 0x99;     // I2C主机控制
sfr I2CMSST = 0x9A;     // I2C主机状态
sfr I2CSLCR = 0x9B;     // I2C从机控制
// ...
```

#### 9. USB相关寄存器
```c
sfr USBCLK = 0xDC;      // USB时钟
sfr USBCON = 0xF4;      // USB控制
sfr USBDAT = 0xEC;      // USB数据
sfr USBADR = 0xED;      // USB地址
// ...
```

#### 10. DMA相关寄存器
```c
sfr DMA_M2M_CFG = 0xFA;     // M2M DMA配置
sfr DMA_M2M_CR = 0xFB;      // M2M DMA控制
sfr DMA_M2M_STA = 0xFC;     // M2M DMA状态
// ...
```

#### 11. RTC相关寄存器
```c
sfr RTCCR = 0x8C;       // RTC控制
sfr RTCCFG = 0x8D;      // RTC配置
sfr RTCIEN = 0x8E;      // RTC中断使能
// ...
```

#### 12. 比较器相关寄存器
```c
sfr CMPCR1 = 0xE6;      // 比较器1控制
sfr CMPCR2 = 0xE7;      // 比较器2控制
```

#### 13. 其他扩展寄存器
```c
sfr WTST = 0x92;        // 程序等待时间控制
sfr EAXFR = 0x97;       // 扩展寄存器访问使能
sfr CKSEL = 0x97;       // 时钟选择
sfr CLKDIV = 0x97;      // 时钟分频
// ...
```

**使用方法**：
```c
#include "AI8051U.H"

void main() {
    P0M1 = 0x00;  // 配置P0口
    P0M0 = 0xFF;  // 推挽输出
    P00 = 0;      // 点亮LED
}
```

---

### AI8051U.INC - 汇编语言包含文件

**文件作用**：为汇编语言提供寄存器定义

**主要内容**：
```asm
; 端口定义
P0      DATA    80H
P1      DATA    90H
P2      DATA    A0H
P3      DATA    B0H

; 定时器
TCON    DATA    88H
TMOD    DATA    89H
TL0     DATA    8AH
TH0     DATA    8CH

; ...其他寄存器定义
```

**使用方法**：
```asm
$INCLUDE (AI8051U.INC)

        ORG     0000H
        LJMP    MAIN

MAIN:
        MOV     P0M1, #00H
        MOV     P0M0, #0FFH
        CLR     P0.0
        ; ...
```

---

### usb_cdc_32.LIB - USB CDC协议库

**文件作用**：USB CDC（虚拟串口）协议实现库

**库功能**：
- USB设备枚举
- CDC类描述符处理
- 端点数据收发
- 波特率设置
- 数据位、停止位、校验位配置
- USB挂起/恢复

**使用示例**：
```c
#include "usb.h"

void main() {
    USB_Init();           // 初始化USB
    EA = 1;              // 使能中断
    
    while(1) {
        if (DeviceState != DEVSTATE_CONFIGURED) continue;
        
        // USB已配置，可以收发数据
        if (RxFlag) {
            RxFlag = 0;
            // 处理接收到的数据
            ProcessRxData(RxBuffer, RxCount);
        }
    }
}
```

**链接方法**（Keil工程）：
```
Project -> Options for Target
  -> Linker -> Misc controls
    添加：../../COMM/usb_cdc_32.LIB
```

---

### usb_hid_32.LIB - USB HID协议库

**文件作用**：USB HID（人机接口设备）协议实现库

**库功能**：
- HID设备枚举
- HID类描述符处理
- 输入/输出报告处理
- 特性报告处理
- 中断端点数据传输

**HID设备类型支持**：
- 键盘
- 鼠标
- 游戏手柄
- 自定义HID设备

**使用示例**：
```c
#include "usb.h"

// HID报告描述符
code BYTE HID_ReportDescriptor[] = {
    0x06, 0x00, 0xFF,  // Usage Page (Vendor Defined)
    0x09, 0x01,        // Usage (Vendor Usage 1)
    // ...
};

void main() {
    USB_Init();
    EA = 1;
    
    while(1) {
        // 发送HID报告
        SendHIDReport(report_data, 8);
    }
}
```

---

### usb.h - USB通用头文件

**文件作用**：USB库的C语言接口头文件

**主要内容**：
```c
// USB设备状态
#define DEVSTATE_DEFAULT      0
#define DEVSTATE_ADDRESS      1
#define DEVSTATE_CONFIGURED   2

// 端点号
#define EP0_SIZE    64
#define EP1_SIZE    64
#define EP2_SIZE    64

// 函数声明
void USB_Init(void);
void USB_SendData(BYTE *buf, BYTE len);
BYTE USB_RecvData(BYTE *buf);

// 外部变量
extern BYTE DeviceState;
extern BYTE RxFlag;
extern BYTE RxBuffer[];
```

---

## 典型示例目录结构

### 简单示例结构（如示例01）

```
01-用P0口做跑马灯/
├── C语言/
│   ├── main.c              # 主程序C源文件
│   ├── sample.hex          # 编译生成的HEX文件（可直接下载）
│   ├── sample.uvopt        # Keil工程选项文件
│   ├── sample.uvproj       # Keil工程文件
│   └── 功能说明.txt        # 功能说明文本
│
└── 汇编/
    ├── LED.asm             # 汇编源文件
    ├── LED.hex             # 汇编编译的HEX文件
    ├── LED.uvopt           # 工程选项
    ├── LED.uvproj          # 工程文件
    └── 功能说明.txt        # 功能说明
```

**文件说明**：
- **main.c / .asm**：源代码文件
- **.hex**：可直接下载到MCU的HEX文件
- **.uvproj**：Keil工程文件，双击打开
- **.uvopt**：工程选项（编译配置等）
- **功能说明.txt**：功能描述和使用说明

---

### 复杂示例结构（如示例27-任务调度系统）

```
27-通过定时器周期性调度任务综合例程/
├── app.h                   # 应用层总头文件
├── Config.h                # 配置文件（时钟、功能选项等）
├── Type_def.h              # 数据类型定义
├── sample.uvproj           # Keil工程文件
├── sample.uvopt            # 工程选项
├── 功能说明.txt            # 功能说明
│
├── Listings/               # 编译生成的列表文件
│   ├── sample.map          # 链接映射文件
│   └── ...
│
├── Objects/                # 编译输出目录
│   ├── sample.hex          # 最终HEX文件
│   ├── *.obj               # 目标文件
│   └── ...
│
└── Sources/                # 源代码目录
    ├── inc/                # 头文件目录
    │   ├── AI8051U.H       # 芯片头文件
    │   ├── System_init.h   # 系统初始化头文件
    │   ├── Task.h          # 任务调度器头文件
    │   ├── adc.h           # ADC模块头文件
    │   ├── app_rtc.h       # RTC应用头文件
    │   ├── app_ntc.h       # 温度采集头文件
    │   ├── app_Display.h   # 显示模块头文件
    │   ├── app_MatrixKey.h # 矩阵键盘头文件
    │   └── app_adcKey.h    # ADC按键头文件
    │
    ├── isr/                # 中断服务函数目录
    │   └── Timer_Isr.c     # 定时器中断处理
    │
    └── src/                # 源文件目录
        ├── main.c          # 主程序
        ├── System_init.c   # 系统初始化
        ├── Task.c          # 任务调度器实现
        ├── adc.c           # ADC驱动
        ├── app_rtc.c       # RTC应用实现
        ├── app_ntc.c       # 温度采集实现
        ├── app_Display.c   # 显示驱动实现
        ├── app_MatrixKey.c # 矩阵键盘实现
        ├── app_adcKey.c    # ADC按键实现
        └── app.c           # 应用层主逻辑
```

**模块化设计优点**：
1. **职责清晰**：每个模块功能单一
2. **易于维护**：修改某功能只需改对应文件
3. **便于复用**：模块可移植到其他项目
4. **团队协作**：多人可并行开发不同模块

---

### USB示例结构（如示例42-USB HID）

```
42-USB-HID协议范例/
├── 功能说明.txt
├── sample.uvproj
├── sample.uvopt
│
├── obj/                    # 输出目录
│   └── usb_hid_xxxx_xxxx.hex  # VID_PID命名的HEX
│
└── src/                    # 源码目录
    ├── AI8051U.h
    ├── config.h            # 配置（VID、PID等）
    ├── main.c              # 主程序
    ├── stc.h               # STC通用定义
    │
    ├── usb_desc.c          # USB描述符定义
    ├── usb_desc.h
    ├── usb_req_std.c       # USB标准请求处理
    ├── usb_req_std.h
    ├── usb_req_class.c     # USB类请求处理（HID）
    ├── usb_req_class.h
    ├── usb_req_vendor.c    # USB厂商请求处理
    ├── usb_req_vendor.h
    ├── usb.c               # USB核心驱动
    ├── usb.h
    ├── util.c              # 工具函数
    └── util.h
```

**USB代码结构**：
- **usb_desc.c**：设备、配置、接口、端点、HID报告描述符
- **usb_req_std.c**：标准请求（获取描述符、设置地址等）
- **usb_req_class.c**：HID类请求（获取报告、设置报告等）
- **usb_req_vendor.c**：自定义请求
- **usb.c**：USB中断处理、端点数据收发

---

### 含多个子示例的结构（如示例60-DMA ADC）

```
60-DMA-ADC采样数据自动存储/
├── 16路ADC转换-串口返回结果/
│   ├── main.c
│   ├── sample.uvproj
│   ├── sample.hex
│   └── 功能说明.txt
│
├── 16路ADC转换使用DMA-串口返回结果-指定缓冲区地址/
│   ├── main.c
│   ├── sample.uvproj
│   ├── sample.hex
│   └── 功能说明.txt
│
└── 16路ADC转换使用DMA-串口返回结果-结构体存储结果/
    ├── main.c
    ├── sample.uvproj
    ├── sample.hex
    └── 功能说明.txt
```

**多子示例说明**：
- 展示同一功能的不同实现方式
- 从简单到复杂逐步学习
- 比较不同方法的优缺点

---

## 文件类型说明

### 源代码文件

| 扩展名 | 类型 | 说明 |
|--------|------|------|
| .c | C源文件 | C语言源代码 |
| .h | C头文件 | 函数声明、宏定义、类型定义 |
| .asm | 汇编源文件 | 汇编语言源代码 |
| .inc | 汇编包含文件 | 汇编宏定义、寄存器定义 |

### 工程文件

| 扩展名 | 类型 | 说明 |
|--------|------|------|
| .uvproj | Keil工程文件 | 双击打开工程 |
| .uvopt | 工程选项文件 | 编译配置、调试设置 |
| .uvgui | 界面配置文件 | 窗口布局等 |

### 输出文件

| 扩展名 | 类型 | 说明 |
|--------|------|------|
| .hex | Intel HEX文件 | 可下载到MCU的程序文件 |
| .bin | 二进制文件 | 原始二进制程序 |
| .obj | 目标文件 | 编译中间文件 |
| .lib | 库文件 | 预编译的函数库 |
| .map | 映射文件 | 内存分配信息 |
| .lst | 列表文件 | 汇编清单 |

### 文档文件

| 扩展名 | 类型 | 说明 |
|--------|------|------|
| .txt | 文本文件 | 功能说明、使用指南 |
| .pdf | PDF文档 | 详细技术文档 |
| .png/.jpg | 图片文件 | 接线图、波形图等 |

---

## 编译输出目录说明

### Listings 目录
存放编译过程生成的列表文件：
- **.lst**：汇编清单，包含源码和机器码对照
- **.map**：链接映射文件，显示内存分配

### Objects 目录
存放编译输出的目标文件：
- **.obj**：每个.c文件编译生成的目标文件
- **.hex**：最终可下载的HEX文件
- **.lib**：库文件

示例：
```
Objects/
├── main.obj          # main.c编译生成
├── uart.obj          # uart.c编译生成
├── sample.hex        # 最终HEX文件
└── sample.lib        # 可选的库文件
```

---

## 头文件包含路径

### 相对路径引用
示例代码中常见的头文件包含方式：

```c
// 引用COMM目录的公共头文件
#include "../../comm/AI8051U.h"

// 引用同级目录的头文件
#include "config.h"

// 引用子目录的头文件
#include "inc/System_init.h"
```

### 路径层级关系
```
示例目录/C语言/main.c
  ├── ../../comm/AI8051U.h     → 向上2层到COMM目录
  ├── config.h                 → 同级目录
  └── inc/System_init.h        → 子目录inc
```

---

## Keil工程配置要点

### 编译器设置
**Target选项**：
- Device: STC AI8051U系列
- Xtal (MHz): 根据示例选择（24、22.1184等）
- Memory Model: XSmall（推荐）

**C251编译器选项**：
- Optimization Level: 根据需要选择
- Define: 预定义宏
- Include Paths: 添加头文件搜索路径

示例配置：
```
C/C++ -> Preprocessor Symbols -> Define:
  MAIN_Fosc=24000000UL

C/C++ -> Include Paths:
  ../../comm
  ./inc
  ./src
```

### 链接器设置
**Linker选项**：
- Misc controls: 添加库文件路径

示例：
```
Linker -> Misc controls:
  ../../COMM/usb_hid_32.LIB
```

### 输出设置
**Output选项**：
- Create HEX File: ✓（生成HEX文件）
- Output Directory: ./Objects/

---

## 代码移植指南

### 移植单个示例到自己的项目

**步骤1：复制源文件**
```
1. 复制示例的main.c（或其他.c文件）
2. 复制相关的.h头文件
3. 复制COMM/AI8051U.H
```

**步骤2：创建Keil工程**
```
1. 新建Keil工程
2. 选择Device: STC AI8051U
3. 添加源文件到工程
4. 配置头文件路径
```

**步骤3：配置编译选项**
```
1. 设置Memory Model为XSmall
2. 设置主时钟频率
3. 如需USB，链接对应.LIB库
```

**步骤4：编译下载**
```
1. 编译生成HEX
2. 使用STC-ISP下载
3. 测试功能
```

### 提取模块到自己的项目

以任务调度模块为例：
```
1. 复制Sources/inc/Task.h
2. 复制Sources/src/Task.c
3. 复制Sources/isr/Timer_Isr.c
4. 在自己的main.c中：
   - #include "Task.h"
   - 初始化定时器
   - 在定时器中断中调用Task_Scheduler()
   - 定义自己的任务函数
```

---

## 常见目录命名规范

### 中文命名
本项目使用中文目录名，便于中文用户理解：
- 优点：功能一目了然
- 缺点：某些工具可能不兼容

### 如果需要英文命名
可对应转换：
```
01-用P0口做跑马灯            → 01-LED-Blink
02-Timer测试                → 02-Timer-Test
10-串口1通信                → 10-UART1-Communication
27-任务调度系统             → 27-Task-Scheduler
42-USB-HID协议              → 42-USB-HID
```

---

## 文档文件说明

### 功能说明.txt
每个示例都包含功能说明文件，内容包括：
1. 功能描述
2. 硬件连接要求
3. 时钟频率设置
4. 波特率等参数
5. 注意事项
6. 使用说明

### PDF文档
部分复杂示例包含PDF文档：
- 详细的原理说明
- 接线图
- 时序图
- 使用教程

示例：
- `80-WS2812/WS2812-AI8051U-SPI直接驱动.pdf`
- `85-示波器/示波器-AI8051U使用说明.pdf`

---

## 总结

### 文件组织原则
1. **分类清晰**：按功能分类，编号有序
2. **层次分明**：简单示例扁平结构，复杂示例模块化
3. **便于理解**：中文命名，功能说明齐全
4. **易于使用**：提供HEX文件，可直接下载测试

### 学习建议
1. **先看说明**：阅读功能说明.txt了解示例功能
2. **直接测试**：使用提供的HEX文件快速测试
3. **研究代码**：打开Keil工程阅读源码
4. **模块移植**：提取有用的模块到自己项目

### 开发建议
1. **模块化设计**：学习示例27的项目组织方式
2. **分层架构**：驱动层、应用层分离
3. **代码复用**：建立自己的公共库
4. **文档齐全**：每个项目添加说明文档

---

**📁 项目结构清晰有序，便于学习和开发！**

